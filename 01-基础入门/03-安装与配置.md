# 第3章：安装与配置

## 3.1 系统要求

### 最低要求

- **操作系统**：macOS、Linux、Windows
- **内存**：至少 512MB（建议 2GB+）
- **磁盘空间**：至少 100MB
- **网络**：能够访问测试目标

### 推荐配置

- **CPU**：2 核以上
- **内存**：4GB 以上
- **操作系统**：macOS 10.14+、Ubuntu 18.04+、Windows 10+

## 3.2 macOS 安装

### 方法 1：使用 Homebrew（推荐）

```bash
# 安装 Homebrew（如果还没有）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 k6
brew install k6

# 验证安装
k6 version
```

### 方法 2：使用 MacPorts

```bash
sudo port install k6
```

### 方法 3：手动安装

```bash
# 下载二进制文件
wget https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-macos-amd64.tar.gz

# 解压
tar -xzf k6-v0.47.0-macos-amd64.tar.gz

# 移动到 PATH
sudo mv k6-v0.47.0-macos-amd64/k6 /usr/local/bin/

# 验证
k6 version
```

## 3.3 Linux 安装

### Debian/Ubuntu

```bash
# 添加 GPG 密钥
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69

# 添加仓库
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list

# 更新包列表
sudo apt-get update

# 安装 k6
sudo apt-get install k6

# 验证安装
k6 version
```

### Red Hat/CentOS/Fedora

```bash
# 添加仓库
sudo yum install https://dl.k6.io/rpm/repo.rpm

# 安装 k6
sudo yum install k6

# 验证安装
k6 version
```

### Arch Linux

```bash
# 使用 AUR
yay -S k6

# 或使用官方二进制
sudo pacman -S k6
```

### 手动安装（通用 Linux）

```bash
# 下载对应架构的二进制文件
wget https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz

# 解压
tar -xzf k6-v0.47.0-linux-amd64.tar.gz

# 移动到 PATH
sudo mv k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

# 验证
k6 version
```

## 3.4 Windows 安装

### 方法 1：使用 Chocolatey

```powershell
# 安装 Chocolatey（如果还没有）
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# 安装 k6
choco install k6

# 验证安装
k6 version
```

### 方法 2：使用 Scoop

```powershell
# 安装 Scoop（如果还没有）
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
irm get.scoop.sh | iex

# 安装 k6
scoop install k6

# 验证安装
k6 version
```

### 方法 3：使用 MSI 安装包

1. 下载 MSI 安装包：
   ```
   https://dl.k6.io/msi/k6-latest-amd64.msi
   ```

2. 双击运行安装程序

3. 按照向导完成安装

4. 验证安装：
   ```powershell
   k6 version
   ```

### 方法 4：手动安装

1. 下载 ZIP 文件：
   ```
   https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-windows-amd64.zip
   ```

2. 解压到目录（如 `C:\k6`）

3. 添加到 PATH 环境变量：
   - 系统属性 → 高级 → 环境变量
   - 编辑 Path，添加 `C:\k6`

4. 验证安装：
   ```powershell
   k6 version
   ```

## 3.5 Docker 安装

### 使用官方镜像

```bash
# 拉取镜像
docker pull grafana/k6:latest

# 运行测试（挂载脚本目录）
docker run --rm -i grafana/k6 run - <script.js

# 或挂载本地文件
docker run --rm -i -v /path/to/script:/scripts grafana/k6 run /scripts/script.js
```

### Docker Compose 示例

```yaml
version: '3'
services:
  k6:
    image: grafana/k6:latest
    volumes:
      - ./scripts:/scripts
    command: run /scripts/test.js
```

## 3.6 验证安装

### 检查版本

```bash
k6 version
```

**输出示例**：
```
k6 v0.47.0 (go1.21.0, darwin/arm64)
```

### 运行测试脚本

创建 `test.js`：
```javascript
import http from 'k6/http';

export default function () {
  http.get('https://test-api.k6.io/public/crocodiles/');
}
```

运行：
```bash
k6 run test.js
```

如果看到测试结果输出，说明安装成功。

## 3.7 环境变量配置

### 常用环境变量

**K6_OUT**：指定输出格式
```bash
export K6_OUT=json=results.json
k6 run script.js
```

**K6_VUS**：设置虚拟用户数
```bash
export K6_VUS=50
k6 run script.js
```

**K6_DURATION**：设置测试持续时间
```bash
export K6_DURATION=5m
k6 run script.js
```

**K6_CLOUD_TOKEN**：k6 Cloud 认证令牌
```bash
export K6_CLOUD_TOKEN=your_token_here
k6 cloud script.js
```

### 配置文件

创建 `.env` 文件：
```bash
K6_VUS=100
K6_DURATION=10m
K6_OUT=json=results.json
```

使用：
```bash
source .env
k6 run script.js
```

## 3.8 常见安装问题解决

### 问题 1：命令未找到

**macOS/Linux**：
```bash
# 检查是否在 PATH 中
which k6

# 如果不在，添加到 PATH
export PATH=$PATH:/usr/local/bin
```

**Windows**：
- 检查环境变量 PATH 是否包含 k6 安装目录
- 重启命令行窗口

### 问题 2：权限 denied

**Linux/macOS**：
```bash
# 使用 sudo
sudo k6 run script.js

# 或修改权限
chmod +x /usr/local/bin/k6
```

### 问题 3：Docker 镜像拉取失败

```bash
# 使用国内镜像源
docker pull registry.cn-hangzhou.aliyuncs.com/acs/k6:latest
```

### 问题 4：版本不匹配

```bash
# 更新到最新版本
# macOS
brew upgrade k6

# Linux
sudo apt-get update && sudo apt-get upgrade k6

# Windows
choco upgrade k6
```

## 3.9 升级 k6

### macOS

```bash
brew upgrade k6
```

### Linux

```bash
sudo apt-get update
sudo apt-get upgrade k6
```

### Windows

```bash
# Chocolatey
choco upgrade k6

# Scoop
scoop update k6
```

### Docker

```bash
docker pull grafana/k6:latest
```

## 3.10 卸载 k6

### macOS

```bash
brew uninstall k6
```

### Linux

```bash
sudo apt-get remove k6
# 或
sudo yum remove k6
```

### Windows

```powershell
# Chocolatey
choco uninstall k6

# 或手动删除安装目录
```

## 3.11 多版本管理

### 使用 asdf

```bash
# 安装 asdf
git clone https://github.com/asdf-vm/asdf.git ~/.asdf

# 添加 k6 插件
asdf plugin add k6

# 安装特定版本
asdf install k6 0.47.0

# 设置全局版本
asdf global k6 0.47.0

# 设置本地版本
asdf local k6 0.47.0
```

## 3.12 总结

k6 的安装非常简单，支持多种方式：

✅ **macOS**：推荐使用 Homebrew  
✅ **Linux**：使用官方仓库或包管理器  
✅ **Windows**：推荐使用 Chocolatey 或 Scoop  
✅ **Docker**：适合容器化环境  

安装后记得验证安装是否成功，然后就可以开始使用 k6 了！

---

**下一章**：[第4章：k6 基础语法](./04-k6基础语法.md)

