# 第7章：检查与断言

## 7.1 check() 函数使用

### 基本用法

```javascript
import { check } from 'k6';
import http from 'k6/http';

export default function () {
  const response = http.get('https://api.example.com/users');
  
  check(response, {
    '状态码是 200': (r) => r.status === 200,
    '响应时间 < 500ms': (r) => r.timings.duration < 500,
  });
}
```

### check() 函数特点

- **不中断测试**：检查失败不会停止测试执行
- **统计结果**：记录检查通过率和失败次数
- **多个检查**：可以同时进行多个检查
- **灵活条件**：支持任意 JavaScript 表达式

## 7.2 状态码检查

### 基本状态码检查

```javascript
check(response, {
  '状态码是 200': (r) => r.status === 200,
  '状态码不是 404': (r) => r.status !== 404,
  '状态码是 2xx': (r) => r.status >= 200 && r.status < 300,
});
```

### 状态码范围检查

```javascript
check(response, {
  '成功响应': (r) => r.status >= 200 && r.status < 300,
  '客户端错误': (r) => r.status >= 400 && r.status < 500,
  '服务器错误': (r) => r.status >= 500 && r.status < 600,
});
```

### 状态文本检查

```javascript
check(response, {
  '状态文本是 OK': (r) => r.status_text === 'OK',
});
```

## 7.3 响应时间检查

### 基本响应时间检查

```javascript
check(response, {
  '响应时间 < 500ms': (r) => r.timings.duration < 500,
  '响应时间 < 1000ms': (r) => r.timings.duration < 1000,
});
```

### 各部分时间检查

```javascript
check(response, {
  '连接时间 < 100ms': (r) => r.timings.connecting < 100,
  '发送时间 < 50ms': (r) => r.timings.sending < 50,
  '等待时间 < 300ms': (r) => r.timings.waiting < 300,
  '接收时间 < 200ms': (r) => r.timings.receiving < 200,
});
```

### 总时间检查

```javascript
check(response, {
  '总时间 < 500ms': (r) => r.timings.duration < 500,
});
```

## 7.4 响应体检查

### 响应体长度检查

```javascript
check(response, {
  '响应体不为空': (r) => r.body.length > 0,
  '响应体长度 > 100': (r) => r.body.length > 100,
});
```

### 响应体内容检查

```javascript
check(response, {
  '包含特定文本': (r) => r.body.includes('success'),
  '不包含错误信息': (r) => !r.body.includes('error'),
});
```

### 响应体大小检查

```javascript
check(response, {
  '响应体大小合理': (r) => r.body.length > 0 && r.body.length < 10000,
});
```

## 7.5 JSON 数据验证

### 基本 JSON 检查

```javascript
check(response, {
  'JSON 格式有效': (r) => {
    try {
      JSON.parse(r.body);
      return true;
    } catch (e) {
      return false;
    }
  },
});
```

### JSON 字段检查

```javascript
check(response, {
  '包含用户ID': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data.id !== undefined;
    } catch {
      return false;
    }
  },
  '用户名不为空': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data.name && data.name.length > 0;
    } catch {
      return false;
    }
  },
});
```

### JSON 数组检查

```javascript
check(response, {
  '返回用户列表': (r) => {
    try {
      const data = JSON.parse(r.body);
      return Array.isArray(data.users) && data.users.length > 0;
    } catch {
      return false;
    }
  },
  '用户数量 > 0': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data.users.length > 0;
    } catch {
      return false;
    }
  },
});
```

### JSON 嵌套字段检查

```javascript
check(response, {
  '用户信息完整': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data.user && 
             data.user.id && 
             data.user.name && 
             data.user.email;
    } catch {
      return false;
    }
  },
});
```

## 7.6 自定义检查逻辑

### 复杂条件检查

```javascript
check(response, {
  '响应符合预期': (r) => {
    if (r.status !== 200) return false;
    
    try {
      const data = JSON.parse(r.body);
      return data.success === true && 
             data.data !== null &&
             r.timings.duration < 500;
    } catch {
      return false;
    }
  },
});
```

### 多步骤检查

```javascript
export default function () {
  // 步骤1：登录
  const loginRes = http.post('https://api.example.com/login', {
    username: 'user',
    password: 'pass',
  });
  
  const loginCheck = check(loginRes, {
    '登录成功': (r) => r.status === 200,
  });
  
  if (!loginCheck) {
    return; // 登录失败，停止后续步骤
  }
  
  const token = JSON.parse(loginRes.body).token;
  
  // 步骤2：获取用户信息
  const userRes = http.get('https://api.example.com/user', {
    headers: { 'Authorization': `Bearer ${token}` },
  });
  
  check(userRes, {
    '获取用户信息成功': (r) => r.status === 200,
  });
}
```

### 使用辅助函数

```javascript
function isValidUserResponse(response) {
  if (response.status !== 200) return false;
  
  try {
    const data = JSON.parse(response.body);
    return data.id && data.name && data.email;
  } catch {
    return false;
  }
}

export default function () {
  const response = http.get('https://api.example.com/user');
  
  check(response, {
    '用户响应有效': isValidUserResponse,
  });
}
```

## 7.7 检查结果统计

### 查看检查结果

运行测试后，k6 会输出检查统计：

```
checks.........................: 100.00% ✓ 300      ✗ 0
  ✓ 状态码是 200................: 100.00% ✓ 100      ✗ 0
  ✓ 响应时间 < 500ms...........: 100.00% ✓ 100      ✗ 0
  ✓ JSON 格式有效...............: 100.00% ✓ 100      ✗ 0
```

### 检查结果说明

- **100.00%**：检查通过率
- **✓ 300**：通过的检查次数
- **✗ 0**：失败的检查次数

### 在脚本中获取检查结果

```javascript
const checkResult = check(response, {
  '状态码是 200': (r) => r.status === 200,
});

if (!checkResult) {
  console.error('检查失败');
}
```

## 7.8 断言最佳实践

### 1. 检查顺序

```javascript
// 好的做法：先检查状态码，再检查内容
check(response, {
  '状态码是 200': (r) => r.status === 200,
  '响应体不为空': (r) => r.body.length > 0,
  'JSON 格式有效': (r) => {
    try {
      JSON.parse(r.body);
      return true;
    } catch {
      return false;
    }
  },
});
```

### 2. 错误处理

```javascript
check(response, {
  '请求成功': (r) => {
    if (r.status === 0) {
      console.error('请求超时或失败');
      return false;
    }
    return r.status === 200;
  },
});
```

### 3. 清晰的检查名称

```javascript
// 好的做法：描述性的名称
check(response, {
  '用户API返回200状态码': (r) => r.status === 200,
  '响应时间小于500毫秒': (r) => r.timings.duration < 500,
});

// 不好的做法：模糊的名称
check(response, {
  'check1': (r) => r.status === 200,
  'check2': (r) => r.timings.duration < 500,
});
```

### 4. 组合检查

```javascript
// 将相关检查组合在一起
check(response, {
  'HTTP 响应正常': (r) => r.status === 200 && r.body.length > 0,
  '性能指标正常': (r) => r.timings.duration < 500 && r.timings.waiting < 300,
});
```

### 5. 使用阈值

```javascript
export const options = {
  thresholds: {
    checks: ['rate>0.95'],  // 检查通过率 > 95%
  },
};
```

## 7.9 常见检查模式

### 模式 1：API 响应检查

```javascript
check(response, {
  '状态码正确': (r) => r.status === 200,
  '响应时间合理': (r) => r.timings.duration < 1000,
  '响应体有效': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data !== null;
    } catch {
      return false;
    }
  },
});
```

### 模式 2：数据完整性检查

```javascript
check(response, {
  '包含必需字段': (r) => {
    try {
      const data = JSON.parse(r.body);
      return data.id && data.name && data.email;
    } catch {
      return false;
    }
  },
  '字段类型正确': (r) => {
    try {
      const data = JSON.parse(r.body);
      return typeof data.id === 'number' &&
             typeof data.name === 'string';
    } catch {
      return false;
    }
  },
});
```

### 模式 3：性能检查

```javascript
check(response, {
  '总时间 < 500ms': (r) => r.timings.duration < 500,
  '等待时间 < 300ms': (r) => r.timings.waiting < 300,
  '连接时间 < 100ms': (r) => r.timings.connecting < 100,
});
```

## 7.10 总结

k6 的检查功能非常强大：

✅ **灵活的条件**：支持任意 JavaScript 表达式  
✅ **多个检查**：可以同时进行多个检查  
✅ **不中断测试**：检查失败不会停止测试  
✅ **统计结果**：自动统计检查通过率  
✅ **与阈值结合**：可以设置检查通过率阈值  

合理使用检查功能，可以更好地验证测试结果！

---

**下一章**：[第8章：指标与阈值](./08-指标与阈值.md)

