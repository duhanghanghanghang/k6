# 第9章：数据驱动测试

## 9.1 CSV 文件读取

### 基本用法

**创建 users.csv**：
```csv
username,password,email
user1,pass123,user1@example.com
user2,pass456,user2@example.com
user3,pass789,user3@example.com
```

**测试脚本**：
```javascript
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

const users = new SharedArray('users', function () {
  return papaparse.parse(open('./users.csv'), { header: true }).data;
});

export const options = {
  vus: users.length,
  duration: '1m',
};

export default function () {
  const user = users[__VU % users.length];
  
  const response = http.post('https://api.example.com/login', {
    username: user.username,
    password: user.password,
  });
  
  check(response, {
    '登录成功': (r) => r.status === 200,
  });
}
```

### SharedArray 的优势

- **内存共享**：所有 VU 共享同一份数据，节省内存
- **只读**：数据在测试过程中不可修改
- **高效**：避免重复加载数据文件

## 9.2 JSON 文件读取

### 基本用法

**创建 users.json**：
```json
[
  {
    "username": "user1",
    "password": "pass123",
    "email": "user1@example.com"
  },
  {
    "username": "user2",
    "password": "pass456",
    "email": "user2@example.com"
  }
]
```

**测试脚本**：
```javascript
import { SharedArray } from 'k6/data';

const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

export default function () {
  const user = users[__VU % users.length];
  
  http.post('https://api.example.com/login', {
    username: user.username,
    password: user.password,
  });
}
```

## 9.3 SharedArray 使用

### 基本语法

```javascript
import { SharedArray } from 'k6/data';

const data = new SharedArray('data_name', function () {
  // 返回数组或对象
  return [1, 2, 3, 4, 5];
});

export default function () {
  const item = data[__VU % data.length];
  console.log('Item:', item);
}
```

### 从文件加载

```javascript
const users = new SharedArray('users', function () {
  const fileContent = open('./users.json');
  return JSON.parse(fileContent);
});
```

### 动态生成数据

```javascript
const testData = new SharedArray('test_data', function () {
  const data = [];
  for (let i = 0; i < 100; i++) {
    data.push({
      id: i,
      name: `User ${i}`,
      email: `user${i}@example.com`,
    });
  }
  return data;
});
```

## 9.4 数据参数化

### 使用环境变量

```javascript
const baseUrl = __ENV.BASE_URL || 'https://api.example.com';
const apiKey = __ENV.API_KEY || 'default-key';

export default function () {
  http.get(`${baseUrl}/users`, {
    headers: { 'X-API-Key': apiKey },
  });
}
```

### 使用配置文件

**config.json**：
```json
{
  "baseUrl": "https://api.example.com",
  "timeout": 5000,
  "retries": 3
}
```

**脚本**：
```javascript
const config = JSON.parse(open('./config.json'));

export default function () {
  http.get(`${config.baseUrl}/users`, {
    timeout: `${config.timeout}ms`,
  });
}
```

## 9.5 动态数据生成

### 随机数据生成

```javascript
function randomString(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function randomEmail() {
  return `user${Math.random().toString(36).substring(7)}@example.com`;
}

export default function () {
  const payload = {
    username: randomString(10),
    email: randomEmail(),
    age: Math.floor(Math.random() * 50) + 18,
  };
  
  http.post('https://api.example.com/users', JSON.stringify(payload));
}
```

### 使用外部库

```javascript
import { randomItem, randomString } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';

const names = ['Alice', 'Bob', 'Charlie', 'David'];

export default function () {
  const payload = {
    name: randomItem(names),
    email: `${randomString(10)}@example.com`,
  };
  
  http.post('https://api.example.com/users', JSON.stringify(payload));
}
```

## 9.6 数据文件最佳实践

### 1. 文件格式选择

**CSV**：
- 适合简单的表格数据
- 易于编辑
- 文件较小

**JSON**：
- 适合复杂嵌套数据
- 支持多种数据类型
- 易于程序处理

### 2. 数据量控制

```javascript
// 好的做法：使用 SharedArray 共享数据
const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

// 不好的做法：每个 VU 都加载文件
export default function () {
  const users = JSON.parse(open('./users.json')); // 重复加载
}
```

### 3. 数据验证

```javascript
const users = new SharedArray('users', function () {
  const data = JSON.parse(open('./users.json'));
  
  // 验证数据格式
  if (!Array.isArray(data)) {
    throw new Error('Users data must be an array');
  }
  
  return data.filter(user => {
    return user.username && user.password; // 过滤无效数据
  });
});
```

### 4. 数据轮询

```javascript
const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

export default function () {
  // 使用 VU ID 和迭代次数确保数据分布均匀
  const userIndex = (__VU * __ITER) % users.length;
  const user = users[userIndex];
  
  http.post('https://api.example.com/login', {
    username: user.username,
    password: user.password,
  });
}
```

## 9.7 实际应用示例

### 示例 1：用户登录测试

**users.csv**：
```csv
username,password
user1,pass123
user2,pass456
user3,pass789
```

**脚本**：
```javascript
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';
import http from 'k6/http';
import { check } from 'k6';

const users = new SharedArray('users', function () {
  return papaparse.parse(open('./users.csv'), { header: true }).data;
});

export const options = {
  vus: users.length,
  duration: '1m',
};

export default function () {
  const user = users[__VU % users.length];
  
  const response = http.post('https://api.example.com/login', 
    JSON.stringify({
      username: user.username,
      password: user.password,
    }),
    {
      headers: { 'Content-Type': 'application/json' },
    }
  );
  
  check(response, {
    '登录成功': (r) => r.status === 200,
  });
}
```

### 示例 2：商品数据测试

**products.json**：
```json
[
  {"id": 1, "name": "Product A", "price": 99.99},
  {"id": 2, "name": "Product B", "price": 199.99},
  {"id": 3, "name": "Product C", "price": 299.99}
]
```

**脚本**：
```javascript
import { SharedArray } from 'k6/data';

const products = new SharedArray('products', function () {
  return JSON.parse(open('./products.json'));
});

export default function () {
  const product = products[Math.floor(Math.random() * products.length)];
  
  // 查询商品
  http.get(`https://api.example.com/products/${product.id}`);
  
  // 添加到购物车
  http.post('https://api.example.com/cart', JSON.stringify({
    productId: product.id,
    quantity: 1,
  }));
}
```

## 9.8 总结

数据驱动测试的优势：

✅ **真实数据**：使用真实数据模拟用户行为  
✅ **易于维护**：数据与脚本分离  
✅ **可扩展**：轻松添加更多测试数据  
✅ **内存高效**：SharedArray 共享数据  
✅ **灵活**：支持 CSV、JSON 等多种格式  

合理使用数据驱动，可以让测试更真实、更易维护！

---

**下一章**：[第10章：分组与标签](./10-分组与标签.md)

