# 第4章：k6 基础语法

## 4.1 脚本结构

### 基本结构

k6 脚本的基本结构如下：

```javascript
// 1. 导入模块
import http from 'k6/http';
import { check, sleep } from 'k6';

// 2. 测试配置
export const options = {
  vus: 10,
  duration: '30s',
};

// 3. 初始化函数（可选）
export function setup() {
  return { data: 'some data' };
}

// 4. 测试主函数
export default function (data) {
  // 测试逻辑
  const response = http.get('https://api.example.com');
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
  sleep(1);
}

// 5. 清理函数（可选）
export function teardown(data) {
  // 清理逻辑
}
```

### 必需部分

- **导入模块**：引入需要的 k6 模块
- **options**：测试配置
- **default 函数**：测试主逻辑

### 可选部分

- **setup 函数**：初始化数据
- **teardown 函数**：清理资源

## 4.2 导入模块

### 内置模块

```javascript
// HTTP 模块
import http from 'k6/http';

// 检查函数
import { check, group } from 'k6';

// 指标模块
import { Counter, Rate, Trend, Gauge } from 'k6/metrics';

// WebSocket 模块
import ws from 'k6/ws';

// gRPC 模块
import grpc from 'k6/net/grpc';

// 数据模块
import { SharedArray } from 'k6/data';

// 工具函数
import { sleep, randomString, randomIntBetween } from 'k6';
```

### 外部模块

```javascript
// 使用 jslib.k6.io 上的模块
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';
import { randomItem, randomString } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';
```

### 导入语法

**默认导入**：
```javascript
import http from 'k6/http';
```

**命名导入**：
```javascript
import { check, sleep } from 'k6';
```

**混合导入**：
```javascript
import http, { check } from 'k6/http';
```

## 4.3 测试配置（options）

### 基本配置

```javascript
export const options = {
  vus: 10,              // 虚拟用户数
  duration: '30s',       // 测试持续时间
};
```

### 分阶段配置

```javascript
export const options = {
  stages: [
    { duration: '30s', target: 20 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
};
```

### 多个场景

```javascript
export const options = {
  scenarios: {
    scenario1: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
    },
    scenario2: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '30s', target: 20 },
      ],
    },
  },
};
```

### 阈值配置

```javascript
export const options = {
  vus: 10,
  duration: '30s',
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};
```

### 标签配置

```javascript
export const options = {
  vus: 10,
  duration: '30s',
  tags: {
    environment: 'staging',
    test_type: 'load',
  },
};
```

## 4.4 默认函数（default function）

### 基本用法

```javascript
export default function () {
  // 测试逻辑
  const response = http.get('https://api.example.com');
  console.log('Response:', response.status);
}
```

### 函数特点

- 每个 VU 每次迭代都会执行
- 可以访问 setup 函数返回的数据
- 可以使用所有导入的模块

### 迭代控制

```javascript
export default function () {
  // 使用 __ITER 获取当前迭代次数
  console.log(`Iteration: ${__ITER}`);
  
  // 使用 __VU 获取当前 VU ID
  console.log(`VU: ${__VU}`);
}
```

## 4.5 初始化函数（setup）

### 基本用法

```javascript
export function setup() {
  // 初始化逻辑
  const data = {
    apiUrl: 'https://api.example.com',
    users: ['user1', 'user2', 'user3'],
  };
  
  return data;
}

export default function (data) {
  // 使用 setup 返回的数据
  const response = http.get(`${data.apiUrl}/users/${data.users[0]}`);
}
```

### 特点

- 每个 VU 执行一次（在 default 函数之前）
- 返回的数据会传递给 default 和 teardown 函数
- 适合准备测试数据、获取认证信息等

### 异步 setup

```javascript
export async function setup() {
  const response = await http.asyncRequest('GET', 'https://api.example.com/config');
  return {
    config: JSON.parse(response.body),
  };
}
```

## 4.6 清理函数（teardown）

### 基本用法

```javascript
export function setup() {
  return { sessionId: 'abc123' };
}

export default function (data) {
  // 测试逻辑
}

export function teardown(data) {
  // 清理逻辑
  console.log('Cleaning up session:', data.sessionId);
  // 可以在这里关闭连接、清理资源等
}
```

### 特点

- 测试结束后执行一次
- 接收 setup 函数返回的数据
- 适合清理资源、关闭连接等

## 4.7 环境变量使用

### 读取环境变量

```javascript
// 使用 __ENV 对象
const apiUrl = __ENV.API_URL || 'https://api.example.com';
const vus = parseInt(__ENV.VUS) || 10;

export const options = {
  vus: vus,
  duration: '30s',
};

export default function () {
  http.get(apiUrl);
}
```

### 传递环境变量

**命令行**：
```bash
k6 run --env API_URL=https://staging.example.com --env VUS=50 script.js
```

**脚本中使用**：
```javascript
const baseUrl = __ENV.BASE_URL || 'https://api.example.com';
```

## 4.8 注释与文档

### 单行注释

```javascript
// 这是单行注释
export default function () {
  http.get('https://api.example.com'); // 发送 GET 请求
}
```

### 多行注释

```javascript
/*
 * 这是多行注释
 * 可以写多行
 */
export default function () {
  http.get('https://api.example.com');
}
```

### JSDoc 风格注释

```javascript
/**
 * 测试用户登录接口
 * @param {string} username - 用户名
 * @param {string} password - 密码
 * @returns {Object} 登录响应
 */
function login(username, password) {
  return http.post('https://api.example.com/login', {
    username: username,
    password: password,
  });
}
```

## 4.9 变量与常量

### 变量声明

```javascript
// let - 可变变量
let count = 0;
count = 10;

// const - 常量
const apiUrl = 'https://api.example.com';
// apiUrl = 'https://other.com'; // 错误：不能重新赋值
```

### 变量作用域

```javascript
const globalVar = 'global';

export default function () {
  const localVar = 'local';
  console.log(globalVar); // 可以访问
  console.log(localVar);   // 可以访问
}

// console.log(localVar); // 错误：不能访问函数内的变量
```

## 4.10 数据类型

### 基本类型

```javascript
// 字符串
const name = 'k6';

// 数字
const count = 100;
const price = 99.99;

// 布尔值
const isActive = true;
const isDisabled = false;

// null 和 undefined
const empty = null;
const notDefined = undefined;
```

### 对象

```javascript
// 对象字面量
const user = {
  id: 1,
  name: 'John',
  email: 'john@example.com',
};

// 访问属性
console.log(user.name);
console.log(user['email']);

// 修改属性
user.name = 'Jane';
```

### 数组

```javascript
// 数组字面量
const users = ['user1', 'user2', 'user3'];

// 访问元素
console.log(users[0]); // 'user1'

// 数组方法
users.push('user4');
users.length; // 4
```

## 4.11 函数

### 函数声明

```javascript
// 函数声明
function greet(name) {
  return `Hello, ${name}!`;
}

// 函数表达式
const greet = function(name) {
  return `Hello, ${name}!`;
};

// 箭头函数
const greet = (name) => {
  return `Hello, ${name}!`;
};

// 简化箭头函数
const greet = (name) => `Hello, ${name}!`;
```

### 函数调用

```javascript
export default function () {
  const message = greet('k6');
  console.log(message);
}
```

## 4.12 控制流

### 条件语句

```javascript
export default function () {
  const response = http.get('https://api.example.com');
  
  if (response.status === 200) {
    console.log('Success');
  } else if (response.status === 404) {
    console.log('Not Found');
  } else {
    console.log('Error');
  }
  
  // 三元运算符
  const message = response.status === 200 ? 'OK' : 'Error';
}
```

### 循环语句

```javascript
// for 循环
for (let i = 0; i < 10; i++) {
  console.log(i);
}

// while 循环
let count = 0;
while (count < 10) {
  console.log(count);
  count++;
}

// for...of 循环
const items = ['a', 'b', 'c'];
for (const item of items) {
  console.log(item);
}
```

## 4.13 错误处理

### try-catch

```javascript
export default function () {
  try {
    const response = http.get('https://api.example.com');
    const data = JSON.parse(response.body);
    console.log(data);
  } catch (error) {
    console.error('Error:', error.message);
  }
}
```

### 错误处理最佳实践

```javascript
export default function () {
  const response = http.get('https://api.example.com');
  
  if (!response) {
    console.error('Request failed');
    return; // 提前返回
  }
  
  try {
    const data = JSON.parse(response.body);
    // 处理数据
  } catch (e) {
    console.error('JSON parse error:', e);
  }
}
```

## 4.14 异步编程

### Promise

```javascript
export default async function () {
  const response = await http.asyncRequest('GET', 'https://api.example.com');
  console.log(response.status);
}
```

### async/await

```javascript
export default async function () {
  try {
    const response1 = await http.asyncRequest('GET', 'https://api.example.com/1');
    const response2 = await http.asyncRequest('GET', 'https://api.example.com/2');
    console.log('Both requests completed');
  } catch (error) {
    console.error('Error:', error);
  }
}
```

## 4.15 模块化

### 创建工具模块

**utils.js**：
```javascript
export function generateRandomEmail() {
  return `user${Math.random().toString(36).substring(7)}@example.com`;
}

export function sleepRandom(min, max) {
  sleep(Math.random() * (max - min) + min);
}
```

**使用**：
```javascript
import { generateRandomEmail, sleepRandom } from './utils.js';

export default function () {
  const email = generateRandomEmail();
  console.log(email);
  sleepRandom(1, 3);
}
```

## 4.16 总结

k6 使用 JavaScript（ES6+）语法，主要特点：

✅ **模块化**：使用 import/export  
✅ **函数式**：支持函数、箭头函数、async/await  
✅ **面向对象**：支持对象、类（部分支持）  
✅ **现代语法**：解构、模板字符串、扩展运算符等  

掌握这些基础语法后，就可以编写复杂的测试脚本了！

---

**下一章**：[第5章：HTTP 请求详解](./05-HTTP请求详解.md)

