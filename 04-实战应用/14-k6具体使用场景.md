# 第14章：k6 具体使用场景

## 14.1 API 性能测试

### 场景描述

测试 RESTful API 的性能，验证接口的响应时间、吞吐量和稳定性。

### 测试脚本示例

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '30s', target: 50 },
    { duration: '1m', target: 100 },
    { duration: '30s', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const response = http.get('https://api.example.com/users');
  
  check(response, {
    '状态码是 200': (r) => r.status === 200,
    '响应时间 < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
```

## 14.2 微服务性能测试

### 场景描述

测试微服务架构中服务间的调用性能，验证服务链路的整体性能。

### 测试脚本示例

```javascript
import http from 'k6/http';
import { group } from 'k6';

export default function () {
  group('用户服务链路', function () {
    // 1. 用户认证
    const authRes = http.post('https://auth-service/api/login', {
      username: 'user',
      password: 'pass',
    });
    
    const token = JSON.parse(authRes.body).token;
    
    // 2. 获取用户信息
    const userRes = http.get('https://user-service/api/user', {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    
    // 3. 获取用户订单
    const ordersRes = http.get('https://order-service/api/orders', {
      headers: { 'Authorization': `Bearer ${token}` },
    });
  });
}
```

## 14.3 网站性能测试

### 场景描述

测试网站的整体性能，包括页面加载时间、资源加载等。

### 测试脚本示例

```javascript
import http from 'k6/http';

export const options = {
  vus: 50,
  duration: '5m',
};

export default function () {
  // 加载主页
  const homePage = http.get('https://www.example.com');
  
  // 加载 CSS 和 JS 资源
  http.batch([
    ['GET', 'https://www.example.com/css/style.css'],
    ['GET', 'https://www.example.com/js/app.js'],
  ]);
}
```

## 14.4 数据库性能测试

### 场景描述

通过 API 间接测试数据库性能，验证数据库查询性能。

### 测试脚本示例

```javascript
import http from 'k6/http';

export default function () {
  // 测试复杂查询接口
  const response = http.get('https://api.example.com/users?page=1&limit=100&sort=created_at');
  
  check(response, {
    '查询成功': (r) => r.status === 200,
    '数据量正确': (r) => {
      const data = JSON.parse(r.body);
      return data.items.length === 100;
    },
  });
}
```

## 14.5 缓存性能测试

### 场景描述

测试缓存系统的命中率和性能提升效果。

### 测试脚本示例

```javascript
import http from 'k6/http';

export default function () {
  // 第一次请求（缓存未命中）
  const firstReq = http.get('https://api.example.com/data/123');
  
  // 第二次请求（应该命中缓存）
  const secondReq = http.get('https://api.example.com/data/123');
  
  check(secondReq, {
    '缓存命中': (r) => r.timings.duration < firstReq.timings.duration,
  });
}
```

## 14.6 消息队列性能测试

### 场景描述

测试消息队列的吞吐量和延迟。

### 测试脚本示例

```javascript
import http from 'k6/http';

export default function () {
  // 发送消息
  const sendRes = http.post('https://api.example.com/messages', {
    topic: 'test-topic',
    message: 'test message',
  });
  
  // 消费消息（轮询）
  const consumeRes = http.get('https://api.example.com/messages/consume');
}
```

## 14.7 实时通信性能测试

### 场景描述

测试 WebSocket 等实时通信协议的性能。

### 测试脚本示例

```javascript
import ws from 'k6/ws';

export default function () {
  const url = 'wss://api.example.com/ws';
  const response = ws.connect(url, {}, function (socket) {
    socket.on('open', function () {
      socket.send(JSON.stringify({ type: 'ping' }));
    });
    
    socket.on('message', function (data) {
      console.log('收到消息:', data);
      socket.close();
    });
  });
}
```

---

**下一章**：[第15章：k6 适合的测试场景](./15-k6适合的测试场景.md)

