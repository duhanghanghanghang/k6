# 第17章：实战案例二：用户登录流程测试

## 17.1 业务流程分析

### 登录流程

```
1. 用户输入用户名和密码
   ↓
2. 前端发送登录请求
   ↓
3. 后端验证用户凭证
   ↓
4. 生成 Token
   ↓
5. 返回 Token 给前端
   ↓
6. 前端使用 Token 访问受保护资源
```

### 测试要点

- 登录接口性能
- Token 生成和验证
- 会话管理
- 错误处理

## 17.2 认证机制处理

### JWT Token 认证

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

const BASE_URL = __ENV.BASE_URL || 'https://api.example.com';

export const options = {
  vus: 50,
  duration: '2m',
  thresholds: {
    'http_req_duration{name:Login}': ['p(95)<500'],
    'http_req_duration{name:GetProfile}': ['p(95)<300'],
    login_success_rate: ['rate>0.95'],
  },
};

// 自定义指标
import { Rate } from 'k6/metrics';
const loginSuccessRate = new Rate('login_success_rate');

export default function () {
  // 步骤1：登录
  const loginPayload = JSON.stringify({
    username: `user${__VU}`,
    password: 'password123',
  });
  
  const loginRes = http.post(
    `${BASE_URL}/api/auth/login`,
    loginPayload,
    {
      headers: { 'Content-Type': 'application/json' },
      tags: { name: 'Login' },
    }
  );
  
  const loginSuccess = check(loginRes, {
    '登录状态码是 200': (r) => r.status === 200,
    '返回 Token': (r) => {
      if (r.status === 200) {
        try {
          const data = JSON.parse(r.body);
          return data.token !== undefined && data.token.length > 0;
        } catch {
          return false;
        }
      }
      return false;
    },
  });
  
  loginSuccessRate.add(loginSuccess);
  
  if (!loginSuccess) {
    console.error(`VU ${__VU}: 登录失败`);
    return;
  }
  
  const token = JSON.parse(loginRes.body).token;
  sleep(1);
  
  // 步骤2：使用 Token 访问受保护资源
  const profileRes = http.get(
    `${BASE_URL}/api/user/profile`,
    {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
      tags: { name: 'GetProfile' },
    }
  );
  
  check(profileRes, {
    '获取用户信息成功': (r) => r.status === 200,
    'Token 有效': (r) => r.status !== 401,
  });
  
  sleep(1);
}
```

### Session Cookie 认证

```javascript
export default function () {
  // 登录（Cookie 自动保存）
  const loginRes = http.post(
    `${BASE_URL}/api/auth/login`,
    JSON.stringify({
      username: `user${__VU}`,
      password: 'password123',
    }),
    {
      headers: { 'Content-Type': 'application/json' },
      tags: { name: 'Login' },
    }
  );
  
  check(loginRes, {
    '登录成功': (r) => r.status === 200,
    '设置 Cookie': (r) => r.cookies.session_id !== undefined,
  });
  
  // 后续请求自动携带 Cookie
  const profileRes = http.get(
    `${BASE_URL}/api/user/profile`,
    { tags: { name: 'GetProfile' } }
  );
  
  check(profileRes, {
    '获取用户信息成功': (r) => r.status === 200,
  });
}
```

## 17.3 会话管理

### Token 刷新机制

```javascript
export default function () {
  let token = null;
  let refreshToken = null;
  
  // 登录获取 Token
  const loginRes = http.post(
    `${BASE_URL}/api/auth/login`,
    JSON.stringify({
      username: `user${__VU}`,
      password: 'password123',
    })
  );
  
  if (loginRes.status === 200) {
    const data = JSON.parse(loginRes.body);
    token = data.token;
    refreshToken = data.refreshToken;
  }
  
  // 使用 Token 访问资源
  for (let i = 0; i < 10; i++) {
    const res = http.get(
      `${BASE_URL}/api/user/profile`,
      {
        headers: { 'Authorization': `Bearer ${token}` },
      }
    );
    
    // Token 过期，刷新 Token
    if (res.status === 401) {
      const refreshRes = http.post(
        `${BASE_URL}/api/auth/refresh`,
        JSON.stringify({ refreshToken: refreshToken })
      );
      
      if (refreshRes.status === 200) {
        const data = JSON.parse(refreshRes.body);
        token = data.token;
      }
    }
    
    sleep(1);
  }
}
```

### 会话超时处理

```javascript
export default function () {
  // 登录
  const loginRes = http.post(`${BASE_URL}/api/auth/login`, {
    username: `user${__VU}`,
    password: 'password123',
  });
  
  if (loginRes.status !== 200) {
    return;
  }
  
  // 模拟长时间会话
  for (let i = 0; i < 20; i++) {
    const res = http.get(
      `${BASE_URL}/api/user/profile`,
      {
        headers: {
          'Authorization': `Bearer ${JSON.parse(loginRes.body).token}`,
        },
      }
    );
    
    if (res.status === 401) {
      console.log('会话已过期，需要重新登录');
      break;
    }
    
    sleep(5); // 每5秒访问一次
  }
}
```

## 17.4 多步骤流程测试

### 完整登录流程

```javascript
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate } from 'k6/metrics';

const loginSuccessRate = new Rate('login_success_rate');

export const options = {
  stages: [
    { duration: '30s', target: 20 },
    { duration: '1m', target: 50 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
};

export default function () {
  let token = null;
  
  group('用户登录流程', function () {
    // 步骤1：登录
    const loginRes = http.post(
      `${BASE_URL}/api/auth/login`,
      JSON.stringify({
        username: `user${__VU}`,
        password: 'password123',
      }),
      {
        headers: { 'Content-Type': 'application/json' },
        tags: { name: 'Login' },
      }
    );
    
    const loginSuccess = check(loginRes, {
      '登录成功': (r) => r.status === 200,
    });
    
    loginSuccessRate.add(loginSuccess);
    
    if (!loginSuccess) {
      return;
    }
    
    token = JSON.parse(loginRes.body).token;
  });
  
  sleep(1);
  
  group('获取用户信息', function () {
    const profileRes = http.get(
      `${BASE_URL}/api/user/profile`,
      {
        headers: { 'Authorization': `Bearer ${token}` },
        tags: { name: 'GetProfile' },
      }
    );
    
    check(profileRes, {
      '获取用户信息成功': (r) => r.status === 200,
    });
  });
  
  sleep(1);
  
  group('更新用户信息', function () {
    const updateRes = http.put(
      `${BASE_URL}/api/user/profile`,
      JSON.stringify({
        email: `updated${__VU}@example.com`,
      }),
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        tags: { name: 'UpdateProfile' },
      }
    );
    
    check(updateRes, {
      '更新用户信息成功': (r) => r.status === 200,
    });
  });
  
  sleep(1);
  
  group('登出', function () {
    const logoutRes = http.post(
      `${BASE_URL}/api/auth/logout`,
      null,
      {
        headers: { 'Authorization': `Bearer ${token}` },
        tags: { name: 'Logout' },
      }
    );
    
    check(logoutRes, {
      '登出成功': (r) => r.status === 200,
    });
  });
}
```

### 错误场景测试

```javascript
export default function () {
  // 测试错误密码
  const wrongPasswordRes = http.post(
    `${BASE_URL}/api/auth/login`,
    JSON.stringify({
      username: `user${__VU}`,
      password: 'wrongpassword',
    })
  );
  
  check(wrongPasswordRes, {
    '错误密码返回 401': (r) => r.status === 401,
  });
  
  // 测试不存在的用户
  const invalidUserRes = http.post(
    `${BASE_URL}/api/auth/login`,
    JSON.stringify({
      username: 'nonexistent',
      password: 'password123',
    })
  );
  
  check(invalidUserRes, {
    '不存在用户返回 401': (r) => r.status === 401,
  });
  
  // 测试无效 Token
  const invalidTokenRes = http.get(
    `${BASE_URL}/api/user/profile`,
    {
      headers: { 'Authorization': 'Bearer invalid_token' },
    }
  );
  
  check(invalidTokenRes, {
    '无效 Token 返回 401': (r) => r.status === 401,
  });
}
```

## 17.5 性能分析

### 关键指标

1. **登录接口性能**：
   - 响应时间
   - 吞吐量
   - 错误率

2. **Token 验证性能**：
   - Token 验证时间
   - 并发验证能力

3. **会话管理性能**：
   - 会话创建时间
   - 会话查询性能

### 优化建议

**发现的问题**：
- 登录接口在高并发下响应时间增加
- Token 验证成为瓶颈

**优化方案**：
1. **登录接口优化**：
   - 使用缓存减少数据库查询
   - 优化密码验证算法
   - 添加限流机制

2. **Token 验证优化**：
   - 使用 Redis 缓存 Token
   - 优化 Token 解析逻辑
   - 使用 JWT 本地验证

## 17.6 总结

用户登录流程测试要点：

✅ **完整流程**：覆盖登录到登出的完整流程  
✅ **认证机制**：支持 Token 和 Cookie 认证  
✅ **会话管理**：测试 Token 刷新和会话超时  
✅ **错误处理**：测试各种错误场景  
✅ **性能分析**：分析登录流程的性能瓶颈  

通过这个案例，可以掌握认证和会话管理的测试方法！

---

**下一章**：[第18章：实战案例三：电商系统性能测试](./18-实战案例-电商系统.md)

