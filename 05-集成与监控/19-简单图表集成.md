# k6 ç®€å•é›†æˆåˆ°å›¾è¡¨

## æ¦‚è¿°

k6 æä¾›äº†å¤šç§è¾“å‡ºæ ¼å¼ï¼Œå¯ä»¥è½»æ¾åœ°å°†æµ‹è¯•ç»“æœå¯è§†åŒ–ã€‚æœ¬ç« ä»‹ç»å¦‚ä½•å°† k6 ç»“æœé›†æˆåˆ°ç®€å•çš„å›¾è¡¨ä¸­ï¼Œé€‚åˆå¿«é€Ÿåˆ†æå’Œå±•ç¤ºã€‚

## JSON è¾“å‡º

### åŸºæœ¬ç”¨æ³•

**è¿è¡Œæµ‹è¯•å¹¶è¾“å‡º JSON**ï¼š
```bash
k6 run --out json=results.json script.js
```

**è¾“å‡ºæ–‡ä»¶ç»“æ„**ï¼š
```json
{
  "metrics": {
    "http_reqs": {
      "values": {
        "count": 1000,
        "rate": 33.33
      }
    },
    "http_req_duration": {
      "values": {
        "min": 120,
        "max": 450,
        "avg": 234.5,
        "med": 220,
        "p90": 350,
        "p95": 380,
        "p99": 420
      }
    }
  }
}
```

### ä½¿ç”¨ Python å¯è§†åŒ–

**å®‰è£…ä¾èµ–**ï¼š
```bash
pip install matplotlib pandas
```

**Python è„šæœ¬**ï¼š
```python
import json
import matplotlib.pyplot as plt
import pandas as pd

# è¯»å– JSON ç»“æœ
with open('results.json', 'r') as f:
    data = json.load(f)

# æå–æŒ‡æ ‡
metrics = data['metrics']
http_req_duration = metrics['http_req_duration']['values']

# åˆ›å»ºå›¾è¡¨
fig, axes = plt.subplots(1, 2, figsize=(12, 5))

# å“åº”æ—¶é—´åˆ†å¸ƒ
labels = ['Min', 'Avg', 'P95', 'P99']
values = [
    http_req_duration['min'],
    http_req_duration['avg'],
    http_req_duration['p95'],
    http_req_duration['p99']
]
axes[0].bar(labels, values, color=['green', 'blue', 'orange', 'red'])
axes[0].set_title('HTTP è¯·æ±‚å“åº”æ—¶é—´')
axes[0].set_ylabel('æ—¶é—´ (ms)')

# è¯·æ±‚é€Ÿç‡
http_reqs = metrics['http_reqs']['values']
axes[1].bar(['æ€»è¯·æ±‚æ•°', 'QPS'], 
            [http_reqs['count'], http_reqs['rate']],
            color=['blue', 'green'])
axes[1].set_title('è¯·æ±‚ç»Ÿè®¡')

plt.tight_layout()
plt.savefig('k6_results.png', dpi=300)
print('å›¾è¡¨å·²ä¿å­˜ä¸º k6_results.png')
```

**è¿è¡Œ**ï¼š
```bash
python visualize.py
```

## CSV è¾“å‡º

### åŸºæœ¬ç”¨æ³•

**è¿è¡Œæµ‹è¯•å¹¶è¾“å‡º CSV**ï¼š
```bash
k6 run --out csv=results.csv script.js
```

**CSV æ ¼å¼**ï¼š
```csv
metric_name,metric_type,time,value,tags
http_reqs,counter,1234567890,100,
http_req_duration,trend,1234567890,234.5,
http_req_failed,rate,1234567890,0.01,
```

### ä½¿ç”¨ Excel å¯è§†åŒ–

**æ­¥éª¤**ï¼š

1. **å¯¼å…¥ CSV**ï¼š
   - æ‰“å¼€ Excel
   - æ•°æ® â†’ ä»æ–‡æœ¬/CSV
   - é€‰æ‹© `results.csv`

2. **åˆ›å»ºæ•°æ®é€è§†è¡¨**ï¼š
   - æ’å…¥ â†’ æ•°æ®é€è§†è¡¨
   - è¡Œï¼šmetric_name
   - å€¼ï¼švalue

3. **åˆ›å»ºå›¾è¡¨**ï¼š
   - é€‰æ‹©æ•°æ®
   - æ’å…¥ â†’ å›¾è¡¨
   - é€‰æ‹©å›¾è¡¨ç±»å‹ï¼ˆæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ç­‰ï¼‰

**ç¤ºä¾‹å›¾è¡¨ç±»å‹**ï¼š
- **å“åº”æ—¶é—´è¶‹åŠ¿**ï¼šæŠ˜çº¿å›¾
- **è¯·æ±‚åˆ†å¸ƒ**ï¼šæŸ±çŠ¶å›¾
- **æˆåŠŸç‡**ï¼šé¥¼å›¾

### ä½¿ç”¨ Python pandas åˆ†æ

```python
import pandas as pd
import matplotlib.pyplot as plt

# è¯»å– CSV
df = pd.read_csv('results.csv')

# ç­›é€‰ HTTP å“åº”æ—¶é—´æ•°æ®
duration_data = df[df['metric_name'] == 'http_req_duration']

# åˆ›å»ºæ—¶é—´åºåˆ—å›¾
plt.figure(figsize=(12, 6))
plt.plot(duration_data['time'], duration_data['value'])
plt.title('HTTP è¯·æ±‚å“åº”æ—¶é—´è¶‹åŠ¿')
plt.xlabel('æ—¶é—´')
plt.ylabel('å“åº”æ—¶é—´ (ms)')
plt.grid(True)
plt.savefig('response_time_trend.png')
```

## ä½¿ç”¨åœ¨çº¿å·¥å…·å¯è§†åŒ–

### æ–¹æ³• 1ï¼šä½¿ç”¨ Google Sheets

1. **ä¸Šä¼  CSV**ï¼š
   - æ‰“å¼€ Google Sheets
   - æ–‡ä»¶ â†’ å¯¼å…¥ â†’ ä¸Šä¼  `results.csv`

2. **åˆ›å»ºå›¾è¡¨**ï¼š
   - é€‰æ‹©æ•°æ®
   - æ’å…¥ â†’ å›¾è¡¨
   - è‡ªå®šä¹‰å›¾è¡¨æ ·å¼

### æ–¹æ³• 2ï¼šä½¿ç”¨åœ¨çº¿å›¾è¡¨å·¥å…·

**æ¨èå·¥å…·**ï¼š
- **Chart.js**ï¼šhttps://www.chartjs.org/
- **Plotly**ï¼šhttps://plotly.com/
- **Datawrapper**ï¼šhttps://www.datawrapper.de/

**ç¤ºä¾‹ï¼ˆä½¿ç”¨ Chart.jsï¼‰**ï¼š
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>k6 æµ‹è¯•ç»“æœå¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>k6 æ€§èƒ½æµ‹è¯•ç»“æœ</h1>
    <div class="chart-container">
        <canvas id="responseTimeChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="requestStatsChart"></canvas>
    </div>
    
    <script>
        // ä» JSON è¯»å–æ•°æ®
        fetch('results.json')
            .then(response => response.json())
            .then(data => {
                const metrics = data.metrics;
                const duration = metrics.http_req_duration.values;
                const reqs = metrics.http_reqs.values;
                
                // å“åº”æ—¶é—´å›¾è¡¨
                const ctx1 = document.getElementById('responseTimeChart');
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Min', 'Avg', 'Med', 'P90', 'P95', 'P99'],
                        datasets: [{
                            label: 'å“åº”æ—¶é—´ (ms)',
                            data: [
                                duration.min,
                                duration.avg,
                                duration.med,
                                duration.p90,
                                duration.p95,
                                duration.p99
                            ],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(220, 53, 69, 0.6)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(255, 99, 132, 1)',
                                'rgba(220, 53, 69, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'HTTP è¯·æ±‚å“åº”æ—¶é—´åˆ†å¸ƒ'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´ (ms)'
                                }
                            }
                        }
                    }
                });
                
                // è¯·æ±‚ç»Ÿè®¡å›¾è¡¨
                const ctx2 = document.getElementById('requestStatsChart');
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['æ€»è¯·æ±‚æ•°', 'QPS'],
                        datasets: [{
                            label: 'è¯·æ±‚ç»Ÿè®¡',
                            data: [reqs.count, reqs.rate],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(75, 192, 192, 0.6)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'è¯·æ±‚ç»Ÿè®¡'
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.body.innerHTML = '<h1>é”™è¯¯ï¼šæ— æ³•åŠ è½½ results.json æ–‡ä»¶</h1>';
            });
    </script>
</body>
</html>
```

## ç®€å•çš„ Python è„šæœ¬åˆ†æ

### å®Œæ•´ç¤ºä¾‹è„šæœ¬

åˆ›å»º `simple_visualize.py`ï¼š

```python
#!/usr/bin/env python3
"""
k6 ç»“æœç®€å•å¯è§†åŒ–è„šæœ¬
ä½¿ç”¨æ–¹æ³•: python simple_visualize.py results.json
"""

import json
import sys
import matplotlib.pyplot as plt
from datetime import datetime

def load_results(json_file):
    """åŠ è½½ k6 JSON ç»“æœ"""
    with open(json_file, 'r') as f:
        return json.load(f)

def extract_metrics(data):
    """æå–å…³é”®æŒ‡æ ‡"""
    metrics = data.get('metrics', {})
    
    result = {
        'http_reqs': {
            'count': metrics.get('http_reqs', {}).get('values', {}).get('count', 0),
            'rate': metrics.get('http_reqs', {}).get('values', {}).get('rate', 0)
        },
        'http_req_duration': metrics.get('http_req_duration', {}).get('values', {}),
        'http_req_failed': metrics.get('http_req_failed', {}).get('values', {}).get('rate', 0)
    }
    
    return result

def create_charts(metrics):
    """åˆ›å»ºå›¾è¡¨"""
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    fig.suptitle('k6 æ€§èƒ½æµ‹è¯•ç»“æœ', fontsize=16, fontweight='bold')
    
    # 1. å“åº”æ—¶é—´ç»Ÿè®¡
    duration = metrics['http_req_duration']
    labels = ['Min', 'Avg', 'Med', 'P90', 'P95', 'P99']
    values = [
        duration.get('min', 0),
        duration.get('avg', 0),
        duration.get('med', 0),
        duration.get('p90', 0),
        duration.get('p95', 0),
        duration.get('p99', 0)
    ]
    
    axes[0, 0].bar(labels, values, color=['green', 'blue', 'cyan', 'orange', 'red', 'darkred'])
    axes[0, 0].set_title('HTTP è¯·æ±‚å“åº”æ—¶é—´åˆ†å¸ƒ')
    axes[0, 0].set_ylabel('æ—¶é—´ (ms)')
    axes[0, 0].grid(True, alpha=0.3)
    
    # 2. è¯·æ±‚ç»Ÿè®¡
    reqs = metrics['http_reqs']
    axes[0, 1].bar(['æ€»è¯·æ±‚æ•°', 'QPS'], 
                   [reqs['count'], reqs['rate']],
                   color=['blue', 'green'])
    axes[0, 1].set_title('è¯·æ±‚ç»Ÿè®¡')
    axes[0, 1].set_ylabel('æ•°é‡')
    axes[0, 1].grid(True, alpha=0.3)
    
    # 3. æˆåŠŸç‡
    failed_rate = metrics['http_req_failed']
    success_rate = 1 - failed_rate
    axes[1, 0].pie([success_rate, failed_rate],
                   labels=['æˆåŠŸ', 'å¤±è´¥'],
                   colors=['green', 'red'],
                   autopct='%1.1f%%',
                   startangle=90)
    axes[1, 0].set_title('è¯·æ±‚æˆåŠŸç‡')
    
    # 4. å“åº”æ—¶é—´å¯¹æ¯”ï¼ˆMin vs Max vs Avgï¼‰
    axes[1, 1].bar(['Min', 'Avg', 'Max'],
                   [duration.get('min', 0),
                    duration.get('avg', 0),
                    duration.get('max', 0)],
                   color=['green', 'blue', 'red'])
    axes[1, 1].set_title('å“åº”æ—¶é—´å¯¹æ¯”')
    axes[1, 1].set_ylabel('æ—¶é—´ (ms)')
    axes[1, 1].grid(True, alpha=0.3)
    
    plt.tight_layout()
    return fig

def print_summary(metrics):
    """æ‰“å°æ‘˜è¦ä¿¡æ¯"""
    print("\n" + "="*50)
    print("k6 æµ‹è¯•ç»“æœæ‘˜è¦")
    print("="*50)
    
    reqs = metrics['http_reqs']
    duration = metrics['http_req_duration']
    failed_rate = metrics['http_req_failed']
    
    print(f"\nğŸ“Š è¯·æ±‚ç»Ÿè®¡:")
    print(f"  æ€»è¯·æ±‚æ•°: {reqs['count']:,}")
    print(f"  è¯·æ±‚é€Ÿç‡: {reqs['rate']:.2f} req/s")
    
    print(f"\nâ±ï¸  å“åº”æ—¶é—´:")
    print(f"  æœ€å°å€¼: {duration.get('min', 0):.2f} ms")
    print(f"  å¹³å‡å€¼: {duration.get('avg', 0):.2f} ms")
    print(f"  ä¸­ä½æ•°: {duration.get('med', 0):.2f} ms")
    print(f"  P95: {duration.get('p95', 0):.2f} ms")
    print(f"  P99: {duration.get('p99', 0):.2f} ms")
    print(f"  æœ€å¤§å€¼: {duration.get('max', 0):.2f} ms")
    
    print(f"\nâœ… æˆåŠŸç‡:")
    success_rate = (1 - failed_rate) * 100
    print(f"  æˆåŠŸç‡: {success_rate:.2f}%")
    print(f"  å¤±è´¥ç‡: {failed_rate * 100:.2f}%")
    
    print("="*50 + "\n")

def main():
    if len(sys.argv) < 2:
        print("ä½¿ç”¨æ–¹æ³•: python simple_visualize.py <k6_results.json>")
        sys.exit(1)
    
    json_file = sys.argv[1]
    
    try:
        # åŠ è½½æ•°æ®
        data = load_results(json_file)
        
        # æå–æŒ‡æ ‡
        metrics = extract_metrics(data)
        
        # æ‰“å°æ‘˜è¦
        print_summary(metrics)
        
        # åˆ›å»ºå›¾è¡¨
        fig = create_charts(metrics)
        
        # ä¿å­˜å›¾è¡¨
        output_file = json_file.replace('.json', '_chart.png')
        fig.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"âœ… å›¾è¡¨å·²ä¿å­˜ä¸º: {output_file}")
        
    except FileNotFoundError:
        print(f"âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ {json_file}")
        sys.exit(1)
    except json.JSONDecodeError:
        print(f"âŒ é”™è¯¯: {json_file} ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ–‡ä»¶")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# è¿è¡Œæµ‹è¯•å¹¶è¾“å‡º JSON
k6 run --out json=results.json script.js

# ç”Ÿæˆå›¾è¡¨
python simple_visualize.py results.json
```

## å®æ—¶ç›‘æ§è„šæœ¬

### ç®€å•çš„å®æ—¶ç›‘æ§

åˆ›å»º `realtime_monitor.py`ï¼š

```python
#!/usr/bin/env python3
"""
k6 å®æ—¶ç›‘æ§è„šæœ¬
ç›‘æ§ k6 è¿è¡Œæ—¶çš„æŒ‡æ ‡
"""

import subprocess
import json
import time
import matplotlib.pyplot as plt
from collections import deque
from datetime import datetime

class K6RealtimeMonitor:
    def __init__(self, max_points=100):
        self.max_points = max_points
        self.timestamps = deque(maxlen=max_points)
        self.response_times = deque(maxlen=max_points)
        self.qps = deque(maxlen=max_points)
        
    def parse_k6_output(self, line):
        """è§£æ k6 è¾“å‡º"""
        try:
            # k6 è¾“å‡ºæ ¼å¼ç¤ºä¾‹: 
            # http_reqs=100, http_req_duration=avg=234ms, http_req_failed=0.01
            if 'http_reqs=' in line:
                # æå–è¯·æ±‚æ•°
                import re
                reqs_match = re.search(r'http_reqs=(\d+)', line)
                if reqs_match:
                    self.qps.append(float(reqs_match.group(1)))
                
                # æå–å“åº”æ—¶é—´
                duration_match = re.search(r'http_req_duration=avg=([\d.]+)ms', line)
                if duration_match:
                    self.response_times.append(float(duration_match.group(1)))
                    self.timestamps.append(datetime.now())
        except Exception as e:
            print(f"è§£æé”™è¯¯: {e}")
    
    def update_chart(self):
        """æ›´æ–°å›¾è¡¨"""
        plt.clf()
        
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))
        
        # å“åº”æ—¶é—´è¶‹åŠ¿
        if self.timestamps:
            ax1.plot(list(self.timestamps), list(self.response_times), 'b-')
            ax1.set_title('å“åº”æ—¶é—´è¶‹åŠ¿')
            ax1.set_ylabel('å“åº”æ—¶é—´ (ms)')
            ax1.grid(True)
        
        # QPS è¶‹åŠ¿
        if self.timestamps:
            ax2.plot(list(self.timestamps), list(self.qps), 'g-')
            ax2.set_title('QPS è¶‹åŠ¿')
            ax2.set_ylabel('è¯·æ±‚/ç§’')
            ax2.set_xlabel('æ—¶é—´')
            ax2.grid(True)
        
        plt.tight_layout()
        plt.pause(0.1)
    
    def monitor(self, k6_process):
        """ç›‘æ§ k6 è¿›ç¨‹"""
        plt.ion()
        
        try:
            # è¯»å– k6 è¾“å‡º
            for line in iter(k6_process.stdout.readline, b''):
                if line:
                    line_str = line.decode('utf-8', errors='ignore')
                    self.parse_k6_output(line_str)
                    self.update_chart()
            
            # ç­‰å¾…è¿›ç¨‹ç»“æŸ
            k6_process.wait()
            
            # æœ€ç»ˆæ›´æ–°ä¸€æ¬¡å›¾è¡¨
            self.update_chart()
            print("\nâœ… k6 æµ‹è¯•å®Œæˆ")
            
        except KeyboardInterrupt:
            print("\nâš ï¸  ç›‘æ§å·²åœæ­¢")
            k6_process.terminate()
        finally:
            plt.ioff()
            plt.show()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # å¯åŠ¨ k6
    k6_process = subprocess.Popen(
        ['k6', 'run', 'script.js'],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    
    # å¯åŠ¨ç›‘æ§
    monitor = K6RealtimeMonitor()
    monitor.monitor(k6_process)
```

## æ€»ç»“

æœ¬ç« ä»‹ç»äº† k6 ç®€å•å›¾è¡¨é›†æˆçš„å‡ ç§æ–¹æ³•ï¼š

1. **JSON è¾“å‡º + Python**ï¼šçµæ´»ï¼Œå¯å®šåˆ¶
2. **CSV è¾“å‡º + Excel**ï¼šç®€å•ï¼Œé€‚åˆéæŠ€æœ¯äººå‘˜
3. **åœ¨çº¿å·¥å…·**ï¼šå¿«é€Ÿï¼Œæ— éœ€å®‰è£…
4. **Python è„šæœ¬**ï¼šè‡ªåŠ¨åŒ–ï¼Œå¯é›†æˆ

**é€‰æ‹©å»ºè®®**ï¼š
- å¿«é€ŸæŸ¥çœ‹ï¼šä½¿ç”¨ Excel
- è‡ªåŠ¨åŒ–æŠ¥å‘Šï¼šä½¿ç”¨ Python è„šæœ¬
- å®æ—¶ç›‘æ§ï¼šä½¿ç”¨å®æ—¶ç›‘æ§è„šæœ¬
- åˆ†äº«å±•ç¤ºï¼šä½¿ç”¨åœ¨çº¿å·¥å…·

---

**ä¸‹ä¸€ç« **ï¼š[k6 é›†æˆåˆ°å®Œæ•´ç›‘æ§ç³»ç»Ÿ](./20-å®Œæ•´ç›‘æ§ç³»ç»Ÿé›†æˆ.md)

