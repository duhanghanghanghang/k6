# 第20章：k6 集成到完整监控系统

## 20.1 概述

在生产环境中，通常需要将 k6 的测试结果集成到完整的监控系统中，实现实时监控、历史数据分析和告警。本章介绍如何将 k6 集成到各种监控系统。

## 20.2 InfluxDB 集成

### InfluxDB 简介

InfluxDB 是一个时序数据库，专门用于存储时间序列数据，非常适合存储性能测试指标。

### 安装 InfluxDB

**Docker 方式**：
```bash
docker run -d -p 8086:8086 \
  -v influxdb-storage:/var/lib/influxdb \
  influxdb:latest
```

**macOS**：
```bash
brew install influxdb
brew services start influxdb
```

### k6 配置

**运行测试并输出到 InfluxDB**：
```bash
k6 run --out influxdb=http://localhost:8086/k6 script.js
```

**指定数据库和认证**：
```bash
k6 run --out influxdb=http://username:password@localhost:8086/k6db script.js
```

### 脚本配置

```javascript
import http from 'k6/http';

export const options = {
  vus: 10,
  duration: '30s',
  // InfluxDB 输出配置
  ext: {
    influxdb: {
      url: 'http://localhost:8086',
      db: 'k6',
      username: 'admin',
      password: 'admin',
    },
  },
};

export default function () {
  http.get('https://api.example.com');
}
```

### 查询数据

**使用 InfluxDB CLI**：
```bash
influx -database k6 -execute "SELECT * FROM http_req_duration LIMIT 10"
```

**使用 HTTP API**：
```bash
curl -G 'http://localhost:8086/query' \
  --data-urlencode "db=k6" \
  --data-urlencode "q=SELECT mean(value) FROM http_req_duration WHERE time > now() - 1h"
```

## 20.3 Grafana 可视化配置

### Grafana 简介

Grafana 是一个开源的数据可视化平台，可以连接多种数据源，包括 InfluxDB。

### 安装 Grafana

**Docker 方式**：
```bash
docker run -d -p 3000:3000 \
  -v grafana-storage:/var/lib/grafana \
  grafana/grafana:latest
```

**macOS**：
```bash
brew install grafana
brew services start grafana
```

### 配置数据源

1. **访问 Grafana**：http://localhost:3000
2. **添加数据源**：
   - Configuration → Data Sources → Add data source
   - 选择 InfluxDB
   - URL: http://localhost:8086
   - Database: k6
   - 点击 Save & Test

### 创建仪表盘

#### 1. 响应时间面板

**查询**：
```sql
SELECT mean("value") FROM "http_req_duration" 
WHERE $timeFilter 
GROUP BY time($__interval) fill(null)
```

**可视化设置**：
- Panel type: Time series
- Unit: milliseconds (ms)
- Legend: {{__field.labels.name}}

#### 2. QPS 面板

**查询**：
```sql
SELECT mean("value") FROM "http_reqs" 
WHERE $timeFilter 
GROUP BY time($__interval) fill(null)
```

**可视化设置**：
- Panel type: Graph
- Unit: reqps (requests/sec)

#### 3. 错误率面板

**查询**：
```sql
SELECT mean("value") FROM "http_req_failed" 
WHERE $timeFilter 
GROUP BY time($__interval) fill(null)
```

**可视化设置**：
- Panel type: Stat
- Unit: percent (0.0-1.0)
- Thresholds: 0-0.01 (green), 0.01-0.05 (yellow), 0.05+ (red)

#### 4. 响应时间分布面板

**查询**：
```sql
SELECT mean("value") FROM "http_req_duration" 
WHERE $timeFilter 
GROUP BY time($__interval), "quantile" fill(null)
```

**可视化设置**：
- Panel type: Time series
- 多个查询：min, avg, p95, p99

### 完整仪表盘配置

**JSON 配置示例**：
```json
{
  "dashboard": {
    "title": "k6 Performance Dashboard",
    "panels": [
      {
        "title": "Response Time",
        "targets": [
          {
            "expr": "SELECT mean(\"value\") FROM \"http_req_duration\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      },
      {
        "title": "QPS",
        "targets": [
          {
            "expr": "SELECT mean(\"value\") FROM \"http_reqs\" WHERE $timeFilter GROUP BY time($__interval)"
          }
        ]
      }
    ]
  }
}
```

**导入方式**：
- Dashboard → Import
- 粘贴 JSON 配置
- 选择数据源
- 点击 Import

## 20.4 Prometheus 集成

### Prometheus 简介

Prometheus 是一个监控和告警系统，使用拉取模式收集指标。

### k6 输出到 Prometheus

**使用 k6-prometheus 扩展**：

```javascript
import http from 'k6/http';
import { check } from 'k6';
import { Counter, Rate, Trend } from 'k6/metrics';
import { prometheus } from 'https://jslib.k6.io/k6-prometheus/0.1.0/index.js';

// 自定义指标
const httpReqs = new Counter('http_reqs_total');
const httpDuration = new Trend('http_req_duration_seconds');
const httpErrors = new Rate('http_req_errors');

export const options = {
  vus: 10,
  duration: '30s',
  ext: {
    prometheus: {
      port: 9090,
      path: '/metrics',
    },
  },
};

export default function () {
  const start = Date.now();
  const response = http.get('https://api.example.com');
  const duration = (Date.now() - start) / 1000;
  
  httpReqs.add(1);
  httpDuration.add(duration);
  httpErrors.add(response.status !== 200);
  
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
}
```

### Prometheus 配置

**prometheus.yml**：
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'k6'
    static_configs:
      - targets: ['localhost:9090']
```

### Grafana 连接 Prometheus

1. **添加数据源**：
   - Configuration → Data Sources → Add data source
   - 选择 Prometheus
   - URL: http://localhost:9090

2. **创建查询**：
   ```
   rate(http_reqs_total[5m])
   histogram_quantile(0.95, http_req_duration_seconds_bucket)
   ```

## 20.5 Datadog 集成

### Datadog 简介

Datadog 是一个云监控平台，提供完整的 APM 和监控解决方案。

### k6 配置

**运行测试**：
```bash
k6 run --out datadog script.js
```

**环境变量配置**：
```bash
export K6_DATADOG_ADDR=datadog-agent:8125
export K6_DATADOG_NAMESPACE=k6
k6 run script.js
```

### 脚本配置

```javascript
import http from 'k6/http';

export const options = {
  vus: 10,
  duration: '30s',
  ext: {
    datadog: {
      apiKey: 'YOUR_API_KEY',
      appKey: 'YOUR_APP_KEY',
      site: 'datadoghq.com',
      namespace: 'k6',
    },
  },
};

export default function () {
  http.get('https://api.example.com');
}
```

### Datadog 仪表盘

1. **访问 Datadog**：https://app.datadoghq.com
2. **创建仪表盘**：
   - Dashboards → New Dashboard
   - 添加 Widget
   - 选择指标：k6.http_req_duration

## 20.6 CloudWatch 集成

### AWS CloudWatch 简介

CloudWatch 是 AWS 的监控服务，可以收集和跟踪指标。

### k6 配置

**安装 AWS CLI 并配置**：
```bash
aws configure
```

**运行测试**：
```bash
k6 run --out cloudwatch script.js
```

### 脚本配置

```javascript
import http from 'k6/http';

export const options = {
  vus: 10,
  duration: '30s',
  ext: {
    cloudwatch: {
      region: 'us-east-1',
      namespace: 'k6',
      accessKeyId: 'YOUR_ACCESS_KEY',
      secretAccessKey: 'YOUR_SECRET_KEY',
    },
  },
};

export default function () {
  http.get('https://api.example.com');
}
```

### CloudWatch 控制台

1. **访问 CloudWatch**：https://console.aws.amazon.com/cloudwatch
2. **查看指标**：
   - Metrics → Custom Namespaces → k6
   - 选择指标查看图表

## 20.7 k6 Cloud 使用

### k6 Cloud 简介

k6 Cloud 是 Grafana Labs 提供的云服务，提供分布式测试和高级分析功能。

### 注册和登录

1. **注册账号**：https://app.k6.io/register
2. **获取 API Token**：Settings → API Tokens

### 使用 k6 Cloud

**运行测试**：
```bash
k6 cloud script.js
```

**使用环境变量**：
```bash
export K6_CLOUD_TOKEN=your_token_here
k6 cloud script.js
```

### k6 Cloud 功能

1. **分布式测试**：
   - 自动分配负载到多个节点
   - 支持大规模测试

2. **高级分析**：
   - 实时监控
   - 详细报告
   - 性能分析

3. **团队协作**：
   - 共享测试结果
   - 团队仪表盘
   - 权限管理

## 20.8 自定义输出格式

### 创建自定义输出扩展

**示例：输出到自定义 API**：

```javascript
// custom-output.js
export function handleSummary(data) {
  const summary = {
    timestamp: new Date().toISOString(),
    metrics: {
      http_reqs: data.metrics.http_reqs.values.count,
      http_req_duration: {
        avg: data.metrics.http_req_duration.values.avg,
        p95: data.metrics.http_req_duration.values['p(95)'],
        p99: data.metrics.http_req_duration.values['p(99)'],
      },
      http_req_failed: data.metrics.http_req_failed.values.rate,
    },
  };
  
  // 发送到自定义 API
  const response = http.post('https://api.example.com/k6-results', 
    JSON.stringify(summary),
    {
      headers: { 'Content-Type': 'application/json' },
    }
  );
  
  return {
    'stdout': JSON.stringify(summary, null, 2),
  };
}
```

**使用**：
```bash
k6 run --summary-export=summary.json script.js
```

## 20.9 实时监控仪表盘

### 完整示例：InfluxDB + Grafana

**架构**：
```
k6 测试 → InfluxDB → Grafana → 实时仪表盘
```

**步骤**：

1. **启动 InfluxDB**：
```bash
docker run -d -p 8086:8086 \
  -e INFLUXDB_DB=k6 \
  influxdb:latest
```

2. **启动 Grafana**：
```bash
docker run -d -p 3000:3000 \
  -e GF_SECURITY_ADMIN_PASSWORD=admin \
  grafana/grafana:latest
```

3. **运行 k6 测试**：
```bash
k6 run --out influxdb=http://localhost:8086/k6 script.js
```

4. **配置 Grafana**：
   - 添加 InfluxDB 数据源
   - 导入 k6 仪表盘模板
   - 查看实时监控

### 仪表盘模板

**k6 官方 Grafana 模板**：
- 访问：https://grafana.com/grafana/dashboards/
- 搜索：k6
- 导入模板 ID：10566

**自定义模板示例**：

```json
{
  "dashboard": {
    "title": "k6 Performance Monitoring",
    "tags": ["k6", "performance"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "measurement": "http_req_duration",
            "groupBy": [{"type": "time", "params": ["$__interval"]}],
            "select": [[{"type": "field", "params": ["value"]}, {"type": "mean"}]]
          }
        ]
      },
      {
        "id": 2,
        "title": "QPS",
        "type": "graph",
        "targets": [
          {
            "measurement": "http_reqs",
            "groupBy": [{"type": "time", "params": ["$__interval"]}],
            "select": [[{"type": "field", "params": ["value"]}, {"type": "mean"}]]
          }
        ]
      },
      {
        "id": 3,
        "title": "Error Rate",
        "type": "stat",
        "targets": [
          {
            "measurement": "http_req_failed",
            "select": [[{"type": "field", "params": ["value"]}, {"type": "last"}]]
          }
        ],
        "thresholds": {
          "steps": [
            {"value": 0, "color": "green"},
            {"value": 0.01, "color": "yellow"},
            {"value": 0.05, "color": "red"}
          ]
        }
      }
    ]
  }
}
```

## 20.10 告警配置

### Grafana 告警

**配置告警规则**：

1. **创建告警**：
   - Alerting → Alert rules → New alert rule
   - 选择数据源和查询
   - 设置条件：`http_req_duration > 1000`
   - 配置通知渠道

2. **告警条件示例**：
   - 响应时间 > 1000ms
   - 错误率 > 1%
   - QPS < 预期值

### Prometheus 告警

**alertmanager.yml**：
```yaml
route:
  group_by: ['alertname']
  receiver: 'web.hook'
receivers:
- name: 'web.hook'
  webhook_configs:
  - url: 'http://your-webhook-url'
```

**告警规则**：
```yaml
groups:
- name: k6_alerts
  rules:
  - alert: HighResponseTime
    expr: http_req_duration_seconds > 1
    for: 5m
    annotations:
      summary: "响应时间过高"
```

## 20.11 最佳实践

### 1. 数据保留策略

**InfluxDB 保留策略**：
```sql
CREATE RETENTION POLICY "k6_retention" ON "k6" 
DURATION 30d REPLICATION 1 DEFAULT
```

### 2. 指标聚合

**定期聚合历史数据**：
```sql
SELECT mean(value) INTO "http_req_duration_1h" 
FROM "http_req_duration" 
GROUP BY time(1h)
```

### 3. 标签使用

**使用标签区分不同测试**：
```javascript
http.get('https://api.example.com', {
  tags: {
    environment: 'production',
    test_type: 'load',
    version: 'v1.0',
  },
});
```

### 4. 性能优化

**批量写入**：
- 使用 InfluxDB 批量写入
- 减少网络请求
- 提高性能

## 20.12 总结

本章介绍了 k6 集成到完整监控系统的多种方式：

1. **InfluxDB + Grafana**：最常用的组合
2. **Prometheus**：适合 Kubernetes 环境
3. **Datadog**：企业级监控平台
4. **CloudWatch**：AWS 环境
5. **k6 Cloud**：官方云服务

**选择建议**：
- 自建环境：InfluxDB + Grafana
- Kubernetes：Prometheus + Grafana
- 企业级：Datadog 或 k6 Cloud
- AWS 环境：CloudWatch

---

**下一章**：[第21章：CI/CD 集成](./21-CICD集成.md)

