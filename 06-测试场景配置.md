# 第6章：测试场景配置

## 6.1 简单场景配置

### 固定虚拟用户数

```javascript
export const options = {
  vus: 10,           // 10 个虚拟用户
  duration: '30s',  // 持续 30 秒
};
```

### 固定迭代次数

```javascript
export const options = {
  vus: 10,
  iterations: 100,  // 总共执行 100 次迭代
};
```

## 6.2 分阶段场景（Stages）

### 基本分阶段配置

```javascript
export const options = {
  stages: [
    { duration: '30s', target: 20 },   // 30秒内增加到20个VU
    { duration: '1m', target: 20 },  // 保持20个VU 1分钟
    { duration: '30s', target: 50 },  // 30秒内增加到50个VU
    { duration: '1m', target: 50 },   // 保持50个VU 1分钟
    { duration: '30s', target: 0 },    // 30秒内减少到0
  ],
};
```

### 渐进式负载测试

```javascript
export const options = {
  stages: [
    { duration: '2m', target: 100 },   // 2分钟增加到100
    { duration: '5m', target: 100 },   // 保持100，5分钟
    { duration: '2m', target: 200 },    // 2分钟增加到200
    { duration: '5m', target: 200 },    // 保持200，5分钟
    { duration: '2m', target: 0 },      // 2分钟减少到0
  ],
};
```

### 峰值测试场景

```javascript
export const options = {
  stages: [
    { duration: '1m', target: 10 },    // 正常负载
    { duration: '10s', target: 500 },   // 突然激增
    { duration: '30s', target: 500 },   // 保持峰值
    { duration: '10s', target: 10 },    // 快速回落
  ],
};
```

## 6.3 多个场景并行

### 基本多场景配置

```javascript
export const options = {
  scenarios: {
    // 场景1：正常负载
    normal_load: {
      executor: 'constant-vus',
      vus: 10,
      duration: '5m',
    },
    
    // 场景2：峰值测试
    spike_test: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '10s', target: 100 },
        { duration: '1m', target: 100 },
        { duration: '10s', target: 0 },
      ],
      startTime: '2m',  // 2分钟后开始
    },
  },
};
```

### 场景调度

```javascript
export const options = {
  scenarios: {
    scenario1: {
      executor: 'constant-vus',
      vus: 10,
      duration: '2m',
      startTime: '0s',   // 立即开始
    },
    scenario2: {
      executor: 'constant-vus',
      vus: 20,
      duration: '2m',
      startTime: '1m',   // 1分钟后开始
    },
    scenario3: {
      executor: 'constant-vus',
      vus: 30,
      duration: '2m',
      startTime: '2m',   // 2分钟后开始
    },
  },
};
```

## 6.4 场景执行器类型

### 1. shared-iterations（共享迭代次数）

所有 VU 共享固定的迭代次数。

```javascript
export const options = {
  scenarios: {
    shared_iterations: {
      executor: 'shared-iterations',
      vus: 10,
      iterations: 100,  // 总共100次迭代，10个VU共享
      maxDuration: '30s',
    },
  },
};
```

### 2. per-vu-iterations（每个 VU 固定迭代次数）

每个 VU 执行固定次数的迭代。

```javascript
export const options = {
  scenarios: {
    per_vu_iterations: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 20,  // 每个VU执行20次迭代
      maxDuration: '30s',
    },
  },
};
```

### 3. constant-vus（固定虚拟用户数）

固定数量的 VU，持续运行指定时间。

```javascript
export const options = {
  scenarios: {
    constant_vus: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
    },
  },
};
```

### 4. ramping-vus（可变虚拟用户数）

VU 数量可以变化，支持分阶段。

```javascript
export const options = {
  scenarios: {
    ramping_vus: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '30s', target: 20 },
        { duration: '1m', target: 20 },
        { duration: '30s', target: 0 },
      ],
    },
  },
};
```

### 5. constant-arrival-rate（固定到达速率）

固定速率执行迭代，自动调整 VU 数量。

```javascript
export const options = {
  scenarios: {
    constant_arrival_rate: {
      executor: 'constant-arrival-rate',
      rate: 10,        // 每秒10个迭代
      timeUnit: '1s',
      duration: '5m',
      preAllocatedVUs: 20,
      maxVUs: 50,
    },
  },
};
```

### 6. ramping-arrival-rate（可变到达速率）

到达速率可以变化，支持分阶段。

```javascript
export const options = {
  scenarios: {
    ramping_arrival_rate: {
      executor: 'ramping-arrival-rate',
      startRate: 0,
      timeUnit: '1s',
      preAllocatedVUs: 20,
      maxVUs: 50,
      stages: [
        { duration: '30s', target: 10 },  // 30秒内增加到每秒10个
        { duration: '1m', target: 10 },    // 保持每秒10个
        { duration: '30s', target: 0 },     // 30秒内减少到0
      ],
    },
  },
};
```

## 6.5 固定虚拟用户数

### 基本配置

```javascript
export const options = {
  vus: 10,
  duration: '30s',
};
```

### 使用场景执行器

```javascript
export const options = {
  scenarios: {
    constant_load: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
    },
  },
};
```

## 6.6 固定迭代次数

### 基本配置

```javascript
export const options = {
  vus: 10,
  iterations: 100,
};
```

### 使用场景执行器

```javascript
export const options = {
  scenarios: {
    fixed_iterations: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 20,  // 每个VU执行20次，总共200次
    },
  },
};
```

## 6.7 固定到达速率

### 基本配置

```javascript
export const options = {
  scenarios: {
    constant_rate: {
      executor: 'constant-arrival-rate',
      rate: 10,        // 每秒10个请求
      timeUnit: '1s',
      duration: '5m',
      preAllocatedVUs: 20,
      maxVUs: 50,
    },
  },
};
```

### 参数说明

- **rate**：目标速率
- **timeUnit**：时间单位（'1s', '1m'）
- **preAllocatedVUs**：预分配的 VU 数量
- **maxVUs**：最大 VU 数量

## 6.8 共享迭代次数

### 基本配置

```javascript
export const options = {
  scenarios: {
    shared: {
      executor: 'shared-iterations',
      vus: 10,
      iterations: 100,  // 10个VU共享100次迭代
      maxDuration: '30s',
    },
  },
};
```

### 使用场景

- 总迭代次数固定
- 不关心每个 VU 的迭代次数
- 快速完成测试

## 6.9 场景调度与时间控制

### 场景开始时间

```javascript
export const options = {
  scenarios: {
    scenario1: {
      executor: 'constant-vus',
      vus: 10,
      duration: '2m',
      startTime: '0s',
    },
    scenario2: {
      executor: 'constant-vus',
      vus: 20,
      duration: '2m',
      startTime: '1m',  // 1分钟后开始
    },
  },
};
```

### 场景持续时间

```javascript
export const options = {
  scenarios: {
    short_test: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
    },
    long_test: {
      executor: 'constant-vus',
      vus: 10,
      duration: '1h',
    },
  },
};
```

### 最大持续时间

```javascript
export const options = {
  scenarios: {
    limited_test: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 1000,
      maxDuration: '10m',  // 最多运行10分钟
    },
  },
};
```

## 6.10 场景标签

### 为场景添加标签

```javascript
export const options = {
  scenarios: {
    api_test: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
      tags: {
        test_type: 'api',
        environment: 'staging',
      },
    },
  },
};
```

## 6.11 优雅停止

### gracefulStop 配置

```javascript
export const options = {
  scenarios: {
    test: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
      gracefulStop: '30s',  // 优雅停止时间
    },
  },
};
```

### 使用场景

- 允许正在执行的请求完成
- 避免突然中断导致的数据不一致

## 6.12 实际应用示例

### 示例 1：负载测试

```javascript
export const options = {
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 100 },
    { duration: '2m', target: 0 },
  ],
};
```

### 示例 2：压力测试

```javascript
export const options = {
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 200 },
    { duration: '5m', target: 300 },
    { duration: '2m', target: 0 },
  ],
};
```

### 示例 3：峰值测试

```javascript
export const options = {
  stages: [
    { duration: '1m', target: 10 },
    { duration: '10s', target: 500 },
    { duration: '30s', target: 500 },
    { duration: '10s', target: 10 },
  ],
};
```

### 示例 4：浸泡测试

```javascript
export const options = {
  vus: 50,
  duration: '2h',  // 长时间运行
};
```

## 6.13 最佳实践

### 1. 合理设置阶段

```javascript
// 好的做法：渐进式增加
stages: [
  { duration: '2m', target: 100 },
  { duration: '5m', target: 100 },
]

// 不好的做法：突然增加
stages: [
  { duration: '1s', target: 1000 },  // 太突然
]
```

### 2. 设置合理的持续时间

```javascript
// 至少运行几分钟，获得稳定数据
duration: '5m'  // 而不是 '10s'
```

### 3. 使用场景标签

```javascript
tags: {
  test_type: 'load',
  environment: 'staging',
}
```

## 6.14 总结

k6 提供了丰富的测试场景配置选项：

✅ **简单场景**：固定 VU 数、固定迭代次数  
✅ **分阶段场景**：渐进式负载、峰值测试  
✅ **多场景并行**：同时运行多个测试场景  
✅ **多种执行器**：6种执行器满足不同需求  
✅ **灵活调度**：控制场景的开始时间和持续时间  

选择合适的场景配置，可以更好地模拟真实用户行为！

---

**下一章**：[第7章：检查与断言](./07-检查与断言.md)

