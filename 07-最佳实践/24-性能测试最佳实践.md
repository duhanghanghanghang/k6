# 第24章：性能测试最佳实践

## 24.1 测试计划制定

### 明确测试目标

**测试目标应该包括**：
- 性能指标（响应时间、吞吐量、错误率）
- 测试场景（负载、压力、峰值等）
- 成功标准（阈值设置）

**示例**：
```javascript
// 测试目标
// 1. P95 响应时间 < 500ms
// 2. 错误率 < 1%
// 3. 支持 100 并发用户
// 4. QPS > 50 req/s

export const options = {
  stages: [
    { duration: '2m', target: 100 },
    { duration: '5m', target: 100 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};
```

## 24.2 测试环境准备

### 环境要求

1. **独立测试环境**：
   - 与生产环境隔离
   - 配置接近生产环境
   - 数据量足够

2. **监控准备**：
   - 应用监控（APM）
   - 系统监控（CPU、内存、网络）
   - 数据库监控

3. **数据准备**：
   - 测试数据充足
   - 数据分布合理
   - 数据清理机制

### 环境检查清单

```javascript
// 环境检查脚本
export function setup() {
  // 检查 API 是否可用
  const healthCheck = http.get('https://api.example.com/health');
  
  if (healthCheck.status !== 200) {
    throw new Error('API 不可用');
  }
  
  // 检查数据库连接
  // ...
  
  return { ready: true };
}
```

## 24.3 测试数据管理

### 数据准备策略

**1. 使用真实数据**：
```javascript
const users = new SharedArray('users', function () {
  return JSON.parse(open('./real-users.json'));
});
```

**2. 动态生成数据**：
```javascript
function generateUser() {
  return {
    username: `user${Math.random().toString(36).substring(7)}`,
    email: `user${Math.random().toString(36).substring(7)}@example.com`,
  };
}
```

**3. 数据轮询**：
```javascript
const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

export default function () {
  const user = users[(__VU * __ITER) % users.length];
  // 使用用户数据
}
```

### 数据清理

```javascript
export function teardown(data) {
  // 清理测试数据
  http.post('https://api.example.com/cleanup', {
    testId: data.testId,
  });
}
```

## 24.4 脚本编写规范

### 1. 代码组织

```javascript
// config.js - 配置
export const config = {
  baseUrl: __ENV.BASE_URL || 'https://api.example.com',
  vus: parseInt(__ENV.VUS) || 10,
};

// utils.js - 工具函数
export function generateEmail() {
  return `user${Math.random().toString(36).substring(7)}@example.com`;
}

// test.js - 主测试脚本
import { config } from './config.js';
import { generateEmail } from './utils.js';
```

### 2. 错误处理

```javascript
export default function () {
  const response = http.get('https://api.example.com/data');
  
  if (!response || response.status === 0) {
    console.error('请求失败');
    return;
  }
  
  if (response.status !== 200) {
    console.error(`请求失败: ${response.status}`);
    return;
  }
  
  try {
    const data = JSON.parse(response.body);
    // 处理数据
  } catch (e) {
    console.error('JSON 解析失败:', e);
  }
}
```

### 3. 日志记录

```javascript
export default function () {
  console.log(`VU ${__VU} - Iteration ${__ITER}`);
  
  const response = http.get('https://api.example.com/data');
  
  if (response.status !== 200) {
    console.error(`请求失败: ${response.status}`);
  }
}
```

## 24.5 结果分析技巧

### 1. 关注关键指标

**响应时间分布**：
- 平均值：整体性能
- P95/P99：极端情况
- 最小值/最大值：性能范围

**错误率**：
- 总体错误率
- 各接口错误率
- 错误类型分布

**吞吐量**：
- QPS
- 各接口 QPS
- 吞吐量趋势

### 2. 对比分析

```javascript
// 保存基准值
const baseline = {
  p95: 450,
  errorRate: 0.005,
};

export const options = {
  thresholds: {
    // 不能比基准差 10% 以上
    http_req_duration: [`p(95)<${baseline.p95 * 1.1}`],
    http_req_failed: [`rate<${baseline.errorRate * 1.1}`],
  },
};
```

### 3. 趋势分析

- 响应时间是否逐渐增加（可能内存泄漏）
- 错误率是否逐渐增加（可能资源耗尽）
- 吞吐量是否下降（可能性能瓶颈）

## 24.6 性能优化建议

### 1. 脚本优化

**使用批处理**：
```javascript
// 好的做法
const responses = http.batch([
  ['GET', 'https://api.example.com/users'],
  ['GET', 'https://api.example.com/posts'],
]);

// 不好的做法
http.get('https://api.example.com/users');
http.get('https://api.example.com/posts');
```

**使用 SharedArray**：
```javascript
// 好的做法
const data = new SharedArray('data', function () {
  return JSON.parse(open('./data.json'));
});

// 不好的做法
export default function () {
  const data = JSON.parse(open('./data.json')); // 每次迭代都加载
}
```

### 2. 测试配置优化

**合理设置 VU 数量**：
```javascript
// 从少量开始，逐步增加
stages: [
  { duration: '1m', target: 10 },
  { duration: '1m', target: 50 },
  { duration: '1m', target: 100 },
]
```

**设置合理的持续时间**：
```javascript
// 至少运行几分钟，获得稳定数据
duration: '5m'  // 而不是 '10s'
```

## 24.7 常见问题解决

### 问题 1：测试工具成为瓶颈

**症状**：
- CPU 使用率 100%
- 内存占用高
- 无法达到目标 QPS

**解决方案**：
- 减少 VU 数量
- 优化脚本（使用批处理）
- 使用分布式测试（k6 Cloud）

### 问题 2：网络成为瓶颈

**症状**：
- 响应时间增加
- 连接超时
- 带宽占用高

**解决方案**：
- 检查网络带宽
- 减少并发连接数
- 使用连接池

### 问题 3：目标系统不稳定

**症状**：
- 错误率突然增加
- 响应时间波动大
- 系统崩溃

**解决方案**：
- 检查系统资源（CPU、内存）
- 检查应用日志
- 降低负载
- 检查数据库性能

## 24.8 测试报告

### 报告内容

1. **测试概述**：
   - 测试目标
   - 测试场景
   - 测试环境

2. **测试结果**：
   - 关键指标
   - 图表展示
   - 对比分析

3. **问题分析**：
   - 发现的问题
   - 性能瓶颈
   - 优化建议

### 报告模板

```markdown
# 性能测试报告

## 测试概述
- 测试时间：2024-01-01
- 测试场景：负载测试
- 测试环境：Staging

## 测试结果
- 平均响应时间：234ms
- P95 响应时间：380ms
- 错误率：0.5%
- QPS：33.33 req/s

## 问题分析
1. 用户查询接口响应时间较长（P95 = 600ms）
2. 高并发下错误率增加（5%）

## 优化建议
1. 优化数据库查询
2. 增加缓存
3. 优化接口逻辑
```

## 24.9 总结

性能测试最佳实践：

✅ **明确目标**：制定清晰的测试计划  
✅ **环境准备**：确保测试环境稳定  
✅ **数据管理**：准备充足的测试数据  
✅ **脚本规范**：编写清晰、可维护的脚本  
✅ **结果分析**：深入分析测试结果  
✅ **持续优化**：根据结果持续改进  

遵循最佳实践，可以获得准确、可靠的测试结果！

---

**下一章**：[第25章：k6 脚本优化](./25-k6脚本优化.md)

