# 第8章：指标与阈值

## 8.1 内置指标详解

### HTTP 指标

k6 自动收集以下 HTTP 相关指标：

- **http_reqs**：HTTP 请求总数
- **http_req_duration**：HTTP 请求持续时间
- **http_req_waiting**：等待服务器响应的时间（TTFB）
- **http_req_connecting**：建立连接的时间
- **http_req_sending**：发送请求的时间
- **http_req_receiving**：接收响应的时间
- **http_req_failed**：失败的请求百分比
- **http_req_blocked**：请求被阻塞的时间

### 系统指标

- **vus**：当前活跃的虚拟用户数
- **vus_max**：最大虚拟用户数
- **iterations**：完成的迭代总数
- **iteration_duration**：迭代持续时间
- **data_received**：接收的数据量（字节）
- **data_sent**：发送的数据量（字节）

## 8.2 HTTP 指标详解

### http_reqs（请求总数）

```javascript
// 统计信息
http_reqs: {
  count: 1000,      // 总请求数
  rate: 33.33,      // 每秒请求数（QPS）
}
```

### http_req_duration（响应时间）

```javascript
// 统计信息
http_req_duration: {
  min: 120,          // 最小值
  max: 450,          // 最大值
  avg: 234.5,        // 平均值
  med: 220,          // 中位数
  p90: 350,          // 90 百分位
  p95: 380,          // 95 百分位
  p99: 420,          // 99 百分位
}
```

### http_req_failed（失败率）

```javascript
// 统计信息
http_req_failed: {
  rate: 0.01,        // 失败率（0-1之间）
  passes: 990,       // 通过的请求数
  fails: 10,          // 失败的请求数
}
```

## 8.3 系统指标详解

### vus（虚拟用户数）

```javascript
vus: {
  value: 10,         // 当前值
  min: 10,           // 最小值
  max: 10,           // 最大值
}
```

### iterations（迭代次数）

```javascript
iterations: {
  count: 100,        // 总迭代次数
  rate: 3.33,        // 每秒迭代次数
}
```

## 8.4 自定义指标

### Counter（计数器）

```javascript
import { Counter } from 'k6/metrics';

const myCounter = new Counter('my_counter');

export default function () {
  myCounter.add(1);
  // 或
  myCounter.add(5);
}
```

**特点**：
- 累计值，只增不减
- 适合统计总数

### Rate（速率）

```javascript
import { Rate } from 'k6/metrics';

const myRate = new Rate('my_rate');

export default function () {
  myRate.add(true);   // 成功
  myRate.add(false);  // 失败
}
```

**特点**：
- 0-1 之间的比率
- 适合统计成功率、失败率

### Trend（趋势）

```javascript
import { Trend } from 'k6/metrics';

const myTrend = new Trend('my_trend');

export default function () {
  myTrend.add(234.5);
  myTrend.add(120);
  myTrend.add(450);
}
```

**特点**：
- 数值序列，可计算统计值
- 适合统计响应时间、大小等

### Gauge（仪表盘）

```javascript
import { Gauge } from 'k6/metrics';

const myGauge = new Gauge('my_gauge');

export default function () {
  myGauge.add(10);   // 设置为 10
  myGauge.add(20);   // 设置为 20
  myGauge.add(15);   // 设置为 15
}
```

**特点**：
- 当前值，可增可减
- 适合统计当前状态

## 8.5 Counter 计数器

### 基本使用

```javascript
import { Counter } from 'k6/metrics';

const totalRequests = new Counter('total_requests');
const successfulRequests = new Counter('successful_requests');

export default function () {
  totalRequests.add(1);
  
  const response = http.get('https://api.example.com');
  if (response.status === 200) {
    successfulRequests.add(1);
  }
}
```

### 统计多个值

```javascript
const requestsByMethod = new Counter('requests_by_method');

export default function () {
  requestsByMethod.add(1, { method: 'GET' });
  requestsByMethod.add(1, { method: 'POST' });
}
```

## 8.6 Rate 速率

### 基本使用

```javascript
import { Rate } from 'k6/metrics';

const successRate = new Rate('success_rate');

export default function () {
  const response = http.get('https://api.example.com');
  successRate.add(response.status === 200);
}
```

### 统计成功率

```javascript
const loginSuccessRate = new Rate('login_success_rate');

export default function () {
  const response = http.post('https://api.example.com/login', {
    username: 'user',
    password: 'pass',
  });
  
  loginSuccessRate.add(response.status === 200);
}
```

## 8.7 Trend 趋势

### 基本使用

```javascript
import { Trend } from 'k6/metrics';

const responseTime = new Trend('response_time');

export default function () {
  const start = Date.now();
  const response = http.get('https://api.example.com');
  const duration = Date.now() - start;
  
  responseTime.add(duration);
}
```

### 统计响应时间

```javascript
const apiResponseTime = new Trend('api_response_time');

export default function () {
  const response = http.get('https://api.example.com');
  apiResponseTime.add(response.timings.duration);
}
```

## 8.8 Gauge 仪表盘

### 基本使用

```javascript
import { Gauge } from 'k6/metrics';

const activeConnections = new Gauge('active_connections');

export default function () {
  // 模拟连接数变化
  activeConnections.add(10);
  sleep(1);
  activeConnections.add(15);
  sleep(1);
  activeConnections.add(8);
}
```

## 8.9 阈值（Thresholds）配置

### 基本阈值配置

```javascript
export const options = {
  vus: 10,
  duration: '30s',
  thresholds: {
    http_req_duration: ['p(95)<500'],  // P95 < 500ms
    http_req_failed: ['rate<0.01'],    // 失败率 < 1%
  },
};
```

### 多个阈值条件

```javascript
thresholds: {
  http_req_duration: [
    'avg<300',      // 平均值 < 300ms
    'p(90)<500',    // P90 < 500ms
    'p(95)<800',    // P95 < 800ms
    'p(99)<1500',   // P99 < 1500ms
  ],
}
```

### 阈值表达式

**比较运算符**：
- `<`：小于
- `>`：大于
- `<=`：小于等于
- `>=`：大于等于
- `==`：等于
- `!=`：不等于

**统计函数**：
- `avg`：平均值
- `min`：最小值
- `max`：最大值
- `med`：中位数
- `p(n)`：n 百分位

**示例**：
```javascript
thresholds: {
  http_req_duration: [
    'avg<300',        // 平均 < 300ms
    'p(95)<500',      // P95 < 500ms
    'max<1000',       // 最大 < 1000ms
  ],
  http_req_failed: [
    'rate<0.01',      // 失败率 < 1%
    'count<10',       // 失败数 < 10
  ],
}
```

## 8.10 阈值表达式详解

### 响应时间阈值

```javascript
thresholds: {
  // 平均值
  'http_req_duration{avg}': ['avg<300'],
  
  // 百分位
  'http_req_duration{p95}': ['p(95)<500'],
  'http_req_duration{p99}': ['p(99)<1000'],
  
  // 最小值/最大值
  'http_req_duration{min}': ['min>0'],
  'http_req_duration{max}': ['max<2000'],
}
```

### 失败率阈值

```javascript
thresholds: {
  http_req_failed: [
    'rate<0.01',      // 失败率 < 1%
    'rate<0.05',      // 失败率 < 5%
  ],
}
```

### 自定义指标阈值

```javascript
import { Rate, Trend } from 'k6/metrics';

const loginSuccessRate = new Rate('login_success_rate');
const apiResponseTime = new Trend('api_response_time');

export const options = {
  thresholds: {
    login_success_rate: ['rate>0.95'],  // 登录成功率 > 95%
    api_response_time: ['p(95)<500'],    // API 响应时间 P95 < 500ms
  },
};
```

## 8.11 测试通过/失败判断

### 阈值失败

如果任何阈值不满足，测试会被标记为失败：

```bash
# 输出示例
thresholds: {
  http_req_duration: ['p(95)<500'],
}

# 如果 P95 = 600ms，测试会失败
# 退出码：非 0
```

### CI/CD 中使用

```yaml
# GitHub Actions
- name: Run k6
  run: k6 run script.js
  # 如果阈值失败，步骤会失败，CI 会停止
```

### 检查阈值结果

```javascript
export const options = {
  thresholds: {
    http_req_duration: ['p(95)<500'],
  },
};

export default function () {
  http.get('https://api.example.com');
}

// 运行后检查退出码
// $? = 0 表示通过，非 0 表示失败
```

## 8.12 标签过滤阈值

### 按标签过滤

```javascript
export default function () {
  http.get('https://api.example.com/users', {
    tags: { name: 'GetUsers', endpoint: '/users' },
  });
  
  http.post('https://api.example.com/users', payload, {
    tags: { name: 'CreateUser', endpoint: '/users' },
  });
}

export const options = {
  thresholds: {
    // 只检查 GET 请求
    'http_req_duration{name:GetUsers}': ['p(95)<300'],
    
    // 只检查 POST 请求
    'http_req_duration{name:CreateUser}': ['p(95)<500'],
  },
};
```

### 多个标签组合

```javascript
thresholds: {
  'http_req_duration{method:GET,endpoint:/users}': ['p(95)<300'],
  'http_req_duration{method:POST,endpoint:/users}': ['p(95)<500'],
}
```

## 8.13 实际应用示例

### 示例 1：API 性能阈值

```javascript
export const options = {
  thresholds: {
    http_req_duration: [
      'avg<300',
      'p(90)<500',
      'p(95)<800',
      'p(99)<1500',
    ],
    http_req_failed: ['rate<0.01'],
    http_reqs: ['rate>10'],  // QPS > 10
  },
};
```

### 示例 2：登录流程阈值

```javascript
import { Rate } from 'k6/metrics';

const loginSuccessRate = new Rate('login_success_rate');

export const options = {
  thresholds: {
    login_success_rate: ['rate>0.95'],
    'http_req_duration{name:Login}': ['p(95)<500'],
  },
};

export default function () {
  const response = http.post('https://api.example.com/login', {
    username: 'user',
    password: 'pass',
  }, {
    tags: { name: 'Login' },
  });
  
  loginSuccessRate.add(response.status === 200);
}
```

### 示例 3：多接口阈值

```javascript
export default function () {
  http.get('https://api.example.com/users', {
    tags: { endpoint: 'users' },
  });
  
  http.get('https://api.example.com/posts', {
    tags: { endpoint: 'posts' },
  });
}

export const options = {
  thresholds: {
    'http_req_duration{endpoint:users}': ['p(95)<300'],
    'http_req_duration{endpoint:posts}': ['p(95)<500'],
  },
};
```

## 8.14 最佳实践

### 1. 设置合理的阈值

```javascript
// 好的做法：基于实际性能设置
thresholds: {
  http_req_duration: ['p(95)<500'],  // 基于历史数据
}

// 不好的做法：阈值过高或过低
thresholds: {
  http_req_duration: ['p(95)<100'],  // 可能无法达到
}
```

### 2. 使用多个阈值

```javascript
// 设置多个阈值，全面评估性能
thresholds: {
  http_req_duration: [
    'avg<300',
    'p(95)<500',
    'p(99)<1000',
  ],
}
```

### 3. 结合标签使用

```javascript
// 为不同接口设置不同阈值
thresholds: {
  'http_req_duration{endpoint:/users}': ['p(95)<300'],
  'http_req_duration{endpoint:/orders}': ['p(95)<500'],
}
```

## 8.15 总结

k6 的指标和阈值功能非常强大：

✅ **丰富的内置指标**：HTTP、系统指标  
✅ **自定义指标**：Counter、Rate、Trend、Gauge  
✅ **灵活的阈值配置**：支持多种表达式  
✅ **标签过滤**：可以针对不同场景设置阈值  
✅ **CI/CD 集成**：阈值失败会中断 CI 流程  

合理使用指标和阈值，可以更好地评估和监控系统性能！

---

**下一章**：[第9章：数据驱动测试](./09-数据驱动测试.md)

