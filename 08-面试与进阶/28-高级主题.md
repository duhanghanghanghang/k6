# 第28章：高级主题

## 28.1 分布式测试

### k6 Cloud 分布式测试

```bash
# 使用 k6 Cloud 进行分布式测试
export K6_CLOUD_TOKEN=your_token
k6 cloud script.js
```

### 手动分布式测试

```bash
# 机器1：运行部分负载
k6 run --vus 50 script.js

# 机器2：运行部分负载
k6 run --vus 50 script.js

# 合并结果进行分析
```

## 28.2 自定义扩展开发

### 创建自定义输出扩展

```javascript
// custom-output.js
export function handleSummary(data) {
  const summary = {
    timestamp: new Date().toISOString(),
    metrics: {
      http_reqs: data.metrics.http_reqs.values.count,
      http_req_duration: {
        avg: data.metrics.http_req_duration.values.avg,
        p95: data.metrics.http_req_duration.values['p(95)'],
      },
    },
  };
  
  // 发送到自定义 API
  http.post('https://api.example.com/k6-results', 
    JSON.stringify(summary)
  );
  
  return {
    'stdout': JSON.stringify(summary, null, 2),
  };
}
```

## 28.3 性能测试平台搭建

### 架构设计

```
k6 测试脚本
    ↓
k6 执行引擎
    ↓
结果收集 (InfluxDB)
    ↓
可视化 (Grafana)
    ↓
告警系统
```

### 平台组件

1. **测试执行**：k6 命令行工具
2. **结果存储**：InfluxDB
3. **可视化**：Grafana
4. **调度**：Jenkins/GitLab CI
5. **告警**：AlertManager

## 28.4 自动化测试框架

### 测试框架结构

```javascript
// framework/config.js
export const config = {
  baseUrl: __ENV.BASE_URL,
  timeout: '10s',
};

// framework/utils.js
export function login(username, password) {
  return http.post(`${config.baseUrl}/login`, {
    username,
    password,
  });
}

// framework/assertions.js
export function assertStatus(response, expectedStatus) {
  return response.status === expectedStatus;
}

// tests/api-test.js
import { login } from '../framework/utils.js';
import { assertStatus } from '../framework/assertions.js';

export default function () {
  const response = login('user', 'pass');
  assertStatus(response, 200);
}
```

## 28.5 性能测试左移

### 左移策略

**1. 开发阶段**：
- 单元测试中的性能检查
- 代码审查时的性能验证

**2. 集成阶段**：
- CI/CD 中的性能测试
- 自动化性能回归

**3. 部署前**：
- 完整的性能测试
- 容量规划验证

### CI/CD 集成示例

```yaml
# .github/workflows/performance.yml
name: Performance Tests

on: [push]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/performance.js
```

## 28.6 总结

高级主题涵盖：

✅ **分布式测试**：大规模测试执行  
✅ **自定义扩展**：扩展 k6 功能  
✅ **平台搭建**：完整的测试平台  
✅ **测试框架**：自动化测试框架  
✅ **测试左移**：早期性能验证  

掌握这些高级主题，可以构建企业级性能测试体系！

---

**下一章**：[第29章：k6 生态与扩展](./29-k6生态与扩展.md)

