# 第10章：分组与标签

## 10.1 group() 函数

### 基本用法

```javascript
import { group } from 'k6';
import http from 'k6/http';

export default function () {
  group('用户认证流程', function () {
    const loginRes = http.post('https://api.example.com/login', {
      username: 'user',
      password: 'pass',
    });
    
    check(loginRes, {
      '登录成功': (r) => r.status === 200,
    });
  });
  
  group('获取用户数据', function () {
    const userRes = http.get('https://api.example.com/user');
    check(userRes, {
      '获取成功': (r) => r.status === 200,
    });
  });
}
```

### 嵌套分组

```javascript
export default function () {
  group('电商流程', function () {
    group('浏览商品', function () {
      http.get('https://api.example.com/products');
    });
    
    group('添加到购物车', function () {
      http.post('https://api.example.com/cart', {
        productId: 123,
        quantity: 1,
      });
    });
    
    group('结算', function () {
      http.post('https://api.example.com/checkout', {
        cartId: 456,
      });
    });
  });
}
```

## 10.2 标签（Tags）使用

### 基本标签

```javascript
const response = http.get('https://api.example.com/users', {
  tags: {
    name: 'GetUsers',
    method: 'GET',
    endpoint: '/users',
  },
});
```

### 标签的作用

- **统计分组**：按标签统计指标
- **过滤分析**：在报告中过滤特定标签
- **阈值设置**：为不同标签设置不同阈值

## 10.3 自定义标签

### 请求标签

```javascript
http.get('https://api.example.com/users', {
  tags: {
    name: 'GetUsers',
    type: 'read',
    priority: 'high',
  },
});
```

### 场景标签

```javascript
export const options = {
  scenarios: {
    api_test: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
      tags: {
        test_type: 'api',
        environment: 'staging',
      },
    },
  },
};
```

### 全局标签

```javascript
export const options = {
  vus: 10,
  duration: '30s',
  tags: {
    environment: 'production',
    test_suite: 'smoke',
  },
};
```

## 10.4 标签过滤与统计

### 在阈值中使用标签

```javascript
export const options = {
  thresholds: {
    // 只统计 GET 请求
    'http_req_duration{method:GET}': ['p(95)<300'],
    
    // 只统计 POST 请求
    'http_req_duration{method:POST}': ['p(95)<500'],
    
    // 只统计特定接口
    'http_req_duration{endpoint:/users}': ['p(95)<300'],
  },
};
```

### 多个标签组合

```javascript
thresholds: {
  'http_req_duration{method:GET,endpoint:/users}': ['p(95)<300'],
  'http_req_duration{method:POST,endpoint:/users}': ['p(95)<500'],
}
```

## 10.5 分组统计报告

### 分组指标

使用 `group` 函数后，k6 会自动统计每个组的指标：

```
group_duration:avg=1.2s
  group::用户认证流程:avg=0.5s
  group::获取用户数据:avg=0.7s
```

### 查看分组统计

```javascript
export default function () {
  group('用户认证', function () {
    http.post('https://api.example.com/login');
  });
  
  group('获取数据', function () {
    http.get('https://api.example.com/user');
  });
}
```

运行后会看到：
```
group_duration:avg=1.2s
  group::用户认证:avg=0.5s
  group::获取数据:avg=0.7s
```

## 10.6 实际应用示例

### 示例 1：API 接口分组

```javascript
export default function () {
  group('用户相关接口', function () {
    http.get('https://api.example.com/users', {
      tags: { category: 'user', operation: 'list' },
    });
    
    http.get('https://api.example.com/users/1', {
      tags: { category: 'user', operation: 'get' },
    });
  });
  
  group('订单相关接口', function () {
    http.get('https://api.example.com/orders', {
      tags: { category: 'order', operation: 'list' },
    });
    
    http.post('https://api.example.com/orders', {
      tags: { category: 'order', operation: 'create' },
    });
  });
}

export const options = {
  thresholds: {
    'http_req_duration{category:user}': ['p(95)<300'],
    'http_req_duration{category:order}': ['p(95)<500'],
  },
};
```

### 示例 2：业务流程分组

```javascript
export default function () {
  group('浏览商品', function () {
    http.get('https://api.example.com/products');
    http.get('https://api.example.com/products/123');
  });
  
  group('添加到购物车', function () {
    http.post('https://api.example.com/cart', {
      productId: 123,
      quantity: 1,
    });
  });
  
  group('结算', function () {
    http.post('https://api.example.com/checkout');
    http.get('https://api.example.com/orders');
  });
}
```

### 示例 3：环境标签

```javascript
const environment = __ENV.ENV || 'staging';

export default function () {
  http.get('https://api.example.com/users', {
    tags: {
      environment: environment,
      endpoint: '/users',
    },
  });
}

export const options = {
  thresholds: {
    [`http_req_duration{environment:${environment}}`]: ['p(95)<500'],
  },
};
```

## 10.7 最佳实践

### 1. 使用有意义的标签名

```javascript
// 好的做法
tags: {
  name: 'GetUserProfile',
  endpoint: '/users/profile',
  method: 'GET',
}

// 不好的做法
tags: {
  tag1: 'value1',
  tag2: 'value2',
}
```

### 2. 标签命名规范

```javascript
// 使用一致的命名规范
tags: {
  service: 'user-service',      // 服务名
  operation: 'get-user',        // 操作名
  version: 'v1',                // 版本
}
```

### 3. 合理使用分组

```javascript
// 好的做法：逻辑相关的操作分组
group('用户认证流程', function () {
  // 登录、获取token、验证token
});

// 不好的做法：不相关的操作分组
group('所有操作', function () {
  // 登录、查询商品、下单
});
```

## 10.8 总结

分组和标签的功能：

✅ **逻辑组织**：group() 函数组织相关操作  
✅ **统计分组**：自动统计每个组的指标  
✅ **灵活过滤**：使用标签过滤和分析  
✅ **阈值设置**：为不同标签设置不同阈值  
✅ **报告清晰**：生成更清晰的测试报告  

合理使用分组和标签，可以让测试更有组织、更易分析！

---

**下一章**：[第11章：WebSocket 测试](./11-WebSocket测试.md)

