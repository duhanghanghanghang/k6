# 第13章：文件操作

## 13.1 文件读取

### 读取文本文件

```javascript
// 读取文本文件
const fileContent = open('./data.txt');
console.log('文件内容:', fileContent);
```

### 读取 JSON 文件

```javascript
// 读取 JSON 文件
const jsonData = JSON.parse(open('./data.json'));
console.log('JSON 数据:', jsonData);
```

### 读取 CSV 文件

```javascript
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

const csvData = papaparse.parse(open('./data.csv'), { header: true }).data;
console.log('CSV 数据:', csvData);
```

## 13.2 文件上传

### 上传文本文件

```javascript
import http from 'k6/http';

export default function () {
  const fileContent = open('./test.txt');
  
  const response = http.post(
    'https://api.example.com/upload',
    fileContent,
    {
      headers: {
        'Content-Type': 'text/plain',
      },
    }
  );
  
  check(response, {
    '上传成功': (r) => r.status === 200,
  });
}
```

### 上传二进制文件

```javascript
import http from 'k6/http';

export default function () {
  // 'b' 表示二进制模式
  const fileData = open('./test.pdf', 'b');
  
  const response = http.post(
    'https://api.example.com/upload',
    fileData,
    {
      headers: {
        'Content-Type': 'application/pdf',
      },
    }
  );
  
  check(response, {
    '上传成功': (r) => r.status === 200,
  });
}
```

### 多部分表单上传

```javascript
import http from 'k6/http';

export default function () {
  const fileData = open('./test.jpg', 'b');
  
  const boundary = '----WebKitFormBoundary7MA4YWxkTrZu0gW';
  const payload = [
    `--${boundary}`,
    'Content-Disposition: form-data; name="file"; filename="test.jpg"',
    'Content-Type: image/jpeg',
    '',
    fileData,
    `--${boundary}--`,
  ].join('\r\n');
  
  const response = http.post(
    'https://api.example.com/upload',
    payload,
    {
      headers: {
        'Content-Type': `multipart/form-data; boundary=${boundary}`,
      },
    }
  );
}
```

## 13.3 文件下载

### 下载文件

```javascript
import http from 'k6/http';

export default function () {
  const response = http.get('https://api.example.com/files/document.pdf');
  
  if (response.status === 200) {
    // 保存文件内容（在实际测试中通常不需要保存）
    const fileContent = response.body;
    console.log('文件大小:', fileContent.length, 'bytes');
  }
}
```

### 验证下载的文件

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const response = http.get('https://api.example.com/files/document.pdf');
  
  check(response, {
    '下载成功': (r) => r.status === 200,
    '文件不为空': (r) => r.body.length > 0,
    'Content-Type 正确': (r) => r.headers['Content-Type'] === 'application/pdf',
  });
}
```

## 13.4 二进制文件处理

### 读取二进制文件

```javascript
// 读取二进制文件
const binaryData = open('./image.jpg', 'b');
console.log('文件大小:', binaryData.length, 'bytes');
```

### 处理二进制数据

```javascript
const fileData = open('./data.bin', 'b');

// 检查文件大小
if (fileData.length > 10 * 1024 * 1024) {
  console.error('文件太大');
  return;
}

// 上传文件
http.post('https://api.example.com/upload', fileData, {
  headers: {
    'Content-Type': 'application/octet-stream',
  },
});
```

## 13.5 实际应用示例

### 示例 1：图片上传测试

```javascript
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  vus: 10,
  duration: '30s',
};

export default function () {
  const imageData = open('./test-image.jpg', 'b');
  
  const response = http.post(
    'https://api.example.com/images/upload',
    imageData,
    {
      headers: {
        'Content-Type': 'image/jpeg',
        'Authorization': 'Bearer token123',
      },
      tags: { name: 'UploadImage' },
    }
  );
  
  check(response, {
    '上传成功': (r) => r.status === 200 || r.status === 201,
    '返回图片URL': (r) => {
      if (r.status === 200 || r.status === 201) {
        const data = JSON.parse(r.body);
        return data.url !== undefined;
      }
      return false;
    },
  });
}
```

### 示例 2：批量文件上传

```javascript
import { SharedArray } from 'k6/data';
import http from 'k6/http';

const files = new SharedArray('files', function () {
  return [
    './file1.pdf',
    './file2.pdf',
    './file3.pdf',
  ];
});

export default function () {
  const filePath = files[__VU % files.length];
  const fileData = open(filePath, 'b');
  
  http.post('https://api.example.com/upload', fileData, {
    headers: {
      'Content-Type': 'application/pdf',
    },
  });
}
```

### 示例 3：文件下载性能测试

```javascript
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { duration: '30s', target: 20 },
    { duration: '1m', target: 50 },
    { duration: '30s', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'],  // 下载时间 < 2秒
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const response = http.get('https://api.example.com/files/large-file.zip', {
    tags: { name: 'DownloadFile' },
  });
  
  check(response, {
    '下载成功': (r) => r.status === 200,
    '文件大小合理': (r) => r.body.length > 0 && r.body.length < 100 * 1024 * 1024,
  });
}
```

## 13.6 最佳实践

### 1. 文件大小限制

```javascript
const fileData = open('./large-file.pdf', 'b');

if (fileData.length > 10 * 1024 * 1024) {
  console.error('文件太大，跳过');
  return;
}
```

### 2. 使用 SharedArray 共享文件

```javascript
import { SharedArray } from 'k6/data';

const files = new SharedArray('files', function () {
  return [
    open('./file1.pdf', 'b'),
    open('./file2.pdf', 'b'),
  ];
});

export default function () {
  const fileData = files[__VU % files.length];
  http.post('https://api.example.com/upload', fileData);
}
```

### 3. 错误处理

```javascript
try {
  const fileData = open('./file.pdf', 'b');
  http.post('https://api.example.com/upload', fileData);
} catch (e) {
  console.error('文件读取失败:', e);
}
```

## 13.7 总结

文件操作要点：

✅ **文件读取**：文本、JSON、CSV、二进制文件  
✅ **文件上传**：文本、二进制、多部分表单  
✅ **文件下载**：下载和验证文件  
✅ **二进制处理**：处理图片、PDF 等二进制文件  
✅ **性能测试**：测试文件上传下载性能  

掌握文件操作，可以测试文件相关的 API！

---

**下一章**：[第17章：实战案例二：用户登录流程测试](./17-实战案例-登录流程.md)

