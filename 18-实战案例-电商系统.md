# 第18章：实战案例三：电商系统性能测试

## 18.1 系统架构分析

### 电商系统架构

```
用户前端
    ↓
API Gateway
    ↓
┌─────────────┬─────────────┬─────────────┐
│  用户服务   │  商品服务   │  订单服务   │
└─────────────┴─────────────┴─────────────┘
    ↓              ↓              ↓
┌─────────────┬─────────────┬─────────────┐
│  用户数据库 │  商品数据库 │  订单数据库 │
└─────────────┴─────────────┴─────────────┘
```

### 核心业务流程

1. **用户注册/登录**
2. **浏览商品**
3. **搜索商品**
4. **查看商品详情**
5. **添加到购物车**
6. **结算下单**
7. **支付**
8. **查看订单**

## 18.2 核心接口识别

### 接口列表

**用户相关**：
- POST /api/users/register - 用户注册
- POST /api/users/login - 用户登录
- GET /api/users/profile - 获取用户信息

**商品相关**：
- GET /api/products - 商品列表
- GET /api/products/:id - 商品详情
- GET /api/products/search - 搜索商品

**购物车相关**：
- GET /api/cart - 获取购物车
- POST /api/cart/items - 添加到购物车
- DELETE /api/cart/items/:id - 删除购物车商品

**订单相关**：
- POST /api/orders - 创建订单
- GET /api/orders - 订单列表
- GET /api/orders/:id - 订单详情

## 18.3 测试场景设计

### 场景 1：正常购物流程

```javascript
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate } from 'k6/metrics';

const purchaseSuccessRate = new Rate('purchase_success_rate');

const BASE_URL = __ENV.BASE_URL || 'https://api.example.com';

export const options = {
  stages: [
    { duration: '2m', target: 50 },
    { duration: '5m', target: 100 },
    { duration: '2m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'],
    http_req_failed: ['rate<0.01'],
    purchase_success_rate: ['rate>0.90'],
  },
};

export default function () {
  let token = null;
  let productId = null;
  let cartId = null;
  
  group('用户登录', function () {
    const loginRes = http.post(
      `${BASE_URL}/api/users/login`,
      JSON.stringify({
        username: `user${__VU}`,
        password: 'password123',
      }),
      {
        headers: { 'Content-Type': 'application/json' },
        tags: { name: 'Login' },
      }
    );
    
    if (loginRes.status === 200) {
      token = JSON.parse(loginRes.body).token;
    }
  });
  
  sleep(1);
  
  group('浏览商品', function () {
    const productsRes = http.get(
      `${BASE_URL}/api/products?page=1&limit=20`,
      {
        headers: { 'Authorization': `Bearer ${token}` },
        tags: { name: 'GetProducts' },
      }
    );
    
    if (productsRes.status === 200) {
      const products = JSON.parse(productsRes.body).products;
      if (products.length > 0) {
        productId = products[0].id;
      }
    }
  });
  
  sleep(1);
  
  group('查看商品详情', function () {
    if (productId) {
      const productRes = http.get(
        `${BASE_URL}/api/products/${productId}`,
        {
          headers: { 'Authorization': `Bearer ${token}` },
          tags: { name: 'GetProductDetail' },
        }
      );
      
      check(productRes, {
        '获取商品详情成功': (r) => r.status === 200,
      });
    }
  });
  
  sleep(1);
  
  group('添加到购物车', function () {
    if (productId) {
      const addToCartRes = http.post(
        `${BASE_URL}/api/cart/items`,
        JSON.stringify({
          productId: productId,
          quantity: 1,
        }),
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          tags: { name: 'AddToCart' },
        }
      );
      
      if (addToCartRes.status === 200 || addToCartRes.status === 201) {
        const cart = JSON.parse(addToCartRes.body);
        cartId = cart.id;
      }
    }
  });
  
  sleep(1);
  
  group('创建订单', function () {
    if (cartId) {
      const orderRes = http.post(
        `${BASE_URL}/api/orders`,
        JSON.stringify({
          cartId: cartId,
        }),
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          tags: { name: 'CreateOrder' },
        }
      );
      
      const orderSuccess = check(orderRes, {
        '创建订单成功': (r) => r.status === 200 || r.status === 201,
      });
      
      purchaseSuccessRate.add(orderSuccess);
    }
  });
  
  sleep(1);
}
```

### 场景 2：高并发浏览商品

```javascript
export const options = {
  stages: [
    { duration: '30s', target: 200 },
    { duration: '2m', target: 500 },
    { duration: '30s', target: 0 },
  ],
  thresholds: {
    'http_req_duration{name:GetProducts}': ['p(95)<500'],
    'http_req_duration{name:GetProductDetail}': ['p(95)<300'],
  },
};

export default function () {
  // 浏览商品列表
  http.get(`${BASE_URL}/api/products?page=1&limit=20`, {
    tags: { name: 'GetProducts' },
  });
  
  sleep(Math.random() * 2 + 1);
  
  // 查看随机商品详情
  const productId = Math.floor(Math.random() * 100) + 1;
  http.get(`${BASE_URL}/api/products/${productId}`, {
    tags: { name: 'GetProductDetail' },
  });
  
  sleep(Math.random() * 3 + 2);
}
```

### 场景 3：搜索商品压力测试

```javascript
export const options = {
  stages: [
    { duration: '1m', target: 50 },
    { duration: '2m', target: 100 },
    { duration: '1m', target: 0 },
  ],
};

const searchKeywords = ['手机', '电脑', '耳机', '键盘', '鼠标'];

export default function () {
  const keyword = searchKeywords[Math.floor(Math.random() * searchKeywords.length)];
  
  const searchRes = http.get(
    `${BASE_URL}/api/products/search?q=${keyword}`,
    {
      tags: { name: 'SearchProducts' },
    }
  );
  
  check(searchRes, {
    '搜索成功': (r) => r.status === 200,
    '返回结果': (r) => {
      if (r.status === 200) {
        const data = JSON.parse(r.body);
        return data.products !== undefined;
      }
      return false;
    },
  });
  
  sleep(1);
}
```

## 18.4 数据准备

### 用户数据

```javascript
import { SharedArray } from 'k6/data';

const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

export default function () {
  const user = users[__VU % users.length];
  // 使用用户数据登录
}
```

### 商品数据

```javascript
const products = new SharedArray('products', function () {
  return JSON.parse(open('./products.json'));
});

export default function () {
  const product = products[Math.floor(Math.random() * products.length)];
  // 使用商品数据
}
```

## 18.5 性能瓶颈分析

### 关键指标监控

```javascript
import { Trend, Rate } from 'k6/metrics';

const productListTime = new Trend('product_list_time');
const productDetailTime = new Trend('product_detail_time');
const orderSuccessRate = new Rate('order_success_rate');

export default function () {
  // 监控商品列表响应时间
  const listStart = Date.now();
  const listRes = http.get(`${BASE_URL}/api/products`);
  productListTime.add(Date.now() - listStart);
  
  // 监控商品详情响应时间
  const detailStart = Date.now();
  const detailRes = http.get(`${BASE_URL}/api/products/1`);
  productDetailTime.add(Date.now() - detailStart);
  
  // 监控订单成功率
  const orderRes = http.post(`${BASE_URL}/api/orders`, {});
  orderSuccessRate.add(orderRes.status === 200 || orderRes.status === 201);
}
```

### 瓶颈识别

**常见瓶颈**：
1. **数据库查询慢**：商品列表接口响应时间长
2. **缓存未命中**：商品详情接口频繁查询数据库
3. **库存检查**：下单时库存检查成为瓶颈
4. **支付接口**：支付接口响应时间长

### 优化建议

**1. 商品列表优化**：
- 使用分页和缓存
- 优化数据库查询
- 使用 CDN 加速

**2. 商品详情优化**：
- 使用 Redis 缓存
- 预加载热门商品
- 优化图片加载

**3. 订单处理优化**：
- 异步处理订单
- 使用消息队列
- 优化库存检查逻辑

## 18.6 综合测试脚本

```javascript
import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate, Trend } from 'k6/metrics';

const purchaseSuccessRate = new Rate('purchase_success_rate');
const pageLoadTime = new Trend('page_load_time');

const BASE_URL = __ENV.BASE_URL || 'https://api.example.com';

export const options = {
  scenarios: {
    // 场景1：正常购物流程
    shopping_flow: {
      executor: 'constant-vus',
      vus: 50,
      duration: '10m',
    },
    // 场景2：高并发浏览
    browsing: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '2m', target: 200 },
        { duration: '5m', target: 500 },
        { duration: '2m', target: 0 },
      ],
      startTime: '1m',
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<1000'],
    http_req_failed: ['rate<0.01'],
    purchase_success_rate: ['rate>0.90'],
  },
};

export default function () {
  const scenario = __ENV.SCENARIO || 'shopping_flow';
  
  if (scenario === 'shopping_flow') {
    // 执行购物流程
    executeShoppingFlow();
  } else if (scenario === 'browsing') {
    // 执行浏览场景
    executeBrowsing();
  }
}

function executeShoppingFlow() {
  // 购物流程逻辑
  // ...
}

function executeBrowsing() {
  // 浏览场景逻辑
  // ...
}
```

## 18.7 总结

电商系统性能测试要点：

✅ **完整流程**：覆盖从浏览到下单的完整流程  
✅ **多场景测试**：购物流程、浏览、搜索等  
✅ **数据准备**：准备用户和商品数据  
✅ **性能分析**：识别性能瓶颈  
✅ **优化建议**：提供针对性的优化方案  

通过这个案例，可以掌握复杂系统的性能测试方法！

---

**下一章**：[第23章：k6 vs 其他工具](./06-对比与分析/23-k6-vs-其他工具.md)

