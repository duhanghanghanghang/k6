# k6 负载测试工具深入学习指南

## 目录
1. [什么是 k6](#什么是-k6)
2. [核心特性与优势](#核心特性与优势)
3. [安装与配置](#安装与配置)
4. [快速开始](#快速开始)
5. [核心概念](#核心概念)
6. [脚本编写详解](#脚本编写详解)
7. [测试场景配置](#测试场景配置)
8. [指标与结果分析](#指标与结果分析)
9. [高级功能](#高级功能)
10. [最佳实践](#最佳实践)
11. [与其他工具对比](#与其他工具对比)
12. [参考资料](#参考资料)

---

## 什么是 k6

k6 是由 **Grafana Labs** 开发的一款现代化、高性能的开源负载测试工具。它使用 Go 语言编写运行时，支持使用 JavaScript（ES6+）编写测试脚本，专为开发者和 DevOps 工程师设计，旨在简化性能测试流程。

### k6 的设计理念

- **开发者优先**：使用熟悉的 JavaScript 语言编写测试脚本
- **高性能**：Go 语言编写，资源占用低，可模拟大量并发用户
- **易于集成**：完美支持 CI/CD 流程，实现持续性能测试
- **云原生**：支持分布式执行和云平台集成

---

## 核心特性与优势

### 1. 开发者友好的脚本语言

- 使用 JavaScript（ES6+）编写测试脚本
- 支持模块化，可以使用 npm 包
- 丰富的 API 和内置函数
- 支持 TypeScript（通过工具链）

### 2. 高性能执行引擎

- **低资源消耗**：单个进程可模拟数千个虚拟用户（VU）
- **高并发能力**：支持 HTTP/1.1、HTTP/2、WebSocket、gRPC 等协议
- **精确控制**：可精确控制虚拟用户的行为和负载模式

### 3. 丰富的测试场景

- **负载测试（Load Testing）**：模拟正常预期负载
- **压力测试（Stress Testing）**：测试系统在极限负载下的表现
- **峰值测试（Spike Testing）**：模拟突然的流量激增
- **浸泡测试（Soak Testing）**：长时间运行测试，发现内存泄漏等问题
- **烟雾测试（Smoke Testing）**：快速验证系统基本功能

### 4. 强大的集成能力

- **CI/CD 集成**：支持 Jenkins、GitLab CI、GitHub Actions 等
- **监控集成**：可输出到 InfluxDB、Grafana、Datadog、CloudWatch 等
- **云平台支持**：k6 Cloud、AWS、Azure、GCP 等

### 5. 详细的指标收集

- HTTP 请求指标（响应时间、状态码、吞吐量等）
- 自定义业务指标
- 阈值（Thresholds）自动判断测试是否通过
- 实时和最终结果报告

---

## 安装与配置

### macOS 安装

```bash
# 使用 Homebrew
brew install k6

# 验证安装
k6 version
```

### Linux 安装

#### Debian/Ubuntu

```bash
sudo apt-get update
sudo apt-get install ca-certificates gnupg2 -y
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

#### Red Hat/CentOS

```bash
sudo yum install https://dl.k6.io/rpm/repo.rpm
sudo yum install k6
```

### Windows 安装

1. 下载 MSI 安装包：https://dl.k6.io/msi/k6-latest-amd64.msi
2. 运行安装程序
3. 验证安装：`k6 version`

### Docker 安装

```bash
# 拉取镜像
docker pull grafana/k6

# 运行测试
docker run --rm -i grafana/k6 run - <script.js
```

---

## 快速开始

### 第一个测试脚本

创建一个名为 `basic-test.js` 的文件：

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

// 测试配置
export const options = {
  vus: 10,              // 虚拟用户数
  duration: '30s',      // 测试持续时间
};

// 测试主函数
export default function () {
  // 发送 HTTP GET 请求
  const response = http.get('https://test-api.k6.io/public/crocodiles/');
  
  // 验证响应
  check(response, {
    '状态码是 200': (r) => r.status === 200,
    '响应时间 < 500ms': (r) => r.timings.duration < 500,
    '响应体不为空': (r) => r.body.length > 0,
  });
  
  // 模拟用户思考时间
  sleep(1);
}
```

### 运行测试

```bash
k6 run basic-test.js
```

### 输出示例

```
          /\      |‾‾| /‾‾/   /‾‾/
     /\  /  \     |  |/  /   /  /
    /  \/    \    |     (   /   ‾‾\
   /          \   |  |\  \ |  (‾)  |
  / __________ \  |__| \__\ \_____/ .io

  execution: local
     script: basic-test.js
     output: -

  scenarios: (100.00%) 1 scenario, 10 max VUs, 1m0s max duration
           ✓ default: 10 looping VUs for 30s (gracefulStop: 30s)

     ✓ 状态码是 200
     ✓ 响应时间 < 500ms
     ✓ 响应体不为空

     checks.........................: 100.00% ✓ 300      ✗ 0
     data_received..................: 45 kB   1.5 kB/s
     data_sent......................: 4.0 kB  133 B/s
     http_req_duration..............: avg=234.5ms min=120ms med=220ms max=450ms p(95)=380ms
     http_req_failed................: 0.00%   ✓ 0        ✗ 100
     http_reqs......................: 100     3.333333/s
     iteration_duration.............: avg=1.23s min=1.12s med=1.20s max=1.50s
     iterations.....................: 100     3.333333/s
     vus............................: 10      min=10     max=10
     vus_max........................: 10      min=10     max=10
```

---

## 核心概念

### 1. 虚拟用户（Virtual Users, VU）

虚拟用户是 k6 中的核心概念，代表一个并发执行的测试脚本实例。每个 VU 会独立运行测试脚本的 `default` 函数。

### 2. 迭代（Iteration）

一次迭代是指一个 VU 完整执行一次 `default` 函数。迭代次数取决于测试配置和脚本执行时间。

### 3. 测试场景（Scenarios）

测试场景定义了如何执行测试，包括：
- VU 数量
- 测试持续时间
- 负载模式（ramp-up、constant、spike 等）

### 4. 指标（Metrics）

k6 自动收集多种指标：
- **HTTP 指标**：请求数、响应时间、错误率等
- **系统指标**：VU 数量、迭代次数等
- **自定义指标**：可以定义业务相关的指标

### 5. 检查（Checks）

检查用于验证响应是否符合预期，但不影响测试执行。使用 `check()` 函数进行验证。

### 6. 阈值（Thresholds）

阈值用于定义测试成功或失败的条件。如果指标超过阈值，测试会被标记为失败。

---

## 脚本编写详解

### 基本结构

```javascript
// 1. 导入模块
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Counter, Rate, Trend } from 'k6/metrics';

// 2. 定义自定义指标（可选）
const myCounter = new Counter('my_counter');
const myRate = new Rate('my_rate');
const myTrend = new Trend('my_trend');

// 3. 定义测试配置
export const options = {
  // 配置项...
};

// 4. 初始化函数（可选，每个 VU 执行一次）
export function setup() {
  // 初始化逻辑，返回数据供 default 函数使用
  return { data: 'some data' };
}

// 5. 测试主函数（每个 VU 每次迭代执行）
export default function (data) {
  // 测试逻辑
}

// 6. 清理函数（可选，测试结束后执行一次）
export function teardown(data) {
  // 清理逻辑
}
```

### HTTP 请求示例

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  // GET 请求
  const getResponse = http.get('https://api.example.com/users');
  
  // POST 请求
  const postResponse = http.post(
    'https://api.example.com/users',
    JSON.stringify({
      name: 'John Doe',
      email: 'john@example.com'
    }),
    {
      headers: { 'Content-Type': 'application/json' },
      tags: { name: 'create_user' }
    }
  );
  
  // PUT 请求
  const putResponse = http.put(
    'https://api.example.com/users/1',
    JSON.stringify({ name: 'Jane Doe' }),
    { headers: { 'Content-Type': 'application/json' } }
  );
  
  // DELETE 请求
  const deleteResponse = http.del('https://api.example.com/users/1');
  
  // 批量请求
  const responses = http.batch([
    ['GET', 'https://api.example.com/users'],
    ['GET', 'https://api.example.com/posts'],
    ['GET', 'https://api.example.com/comments'],
  ]);
}
```

### 使用检查（Checks）

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const response = http.get('https://api.example.com/users');
  
  check(response, {
    // 状态码检查
    '状态码是 200': (r) => r.status === 200,
    '状态码不是 404': (r) => r.status !== 404,
    
    // 响应时间检查
    '响应时间 < 500ms': (r) => r.timings.duration < 500,
    '响应时间 < 1000ms': (r) => r.timings.duration < 1000,
    
    // 响应体检查
    '响应体包含用户ID': (r) => r.body.includes('user_id'),
    '响应体长度 > 0': (r) => r.body.length > 0,
    
    // JSON 响应检查
    'JSON 响应有效': (r) => {
      try {
        JSON.parse(r.body);
        return true;
      } catch (e) {
        return false;
      }
    },
  });
}
```

### 自定义指标

```javascript
import { Counter, Rate, Trend } from 'k6/metrics';
import http from 'k6/http';

// 定义自定义指标
const myCounter = new Counter('my_counter');
const myRate = new Rate('my_rate');
const myTrend = new Trend('my_trend');

export default function () {
  const response = http.get('https://api.example.com/data');
  
  // 增加计数器
  myCounter.add(1);
  
  // 记录速率（成功/失败）
  myRate.add(response.status === 200);
  
  // 记录趋势值（如响应时间）
  myTrend.add(response.timings.duration);
}
```

### 使用环境变量和选项

```javascript
import http from 'k6/http';

export const options = {
  vus: __ENV.VUS || 10,
  duration: __ENV.DURATION || '30s',
};

export default function () {
  const baseUrl = __ENV.BASE_URL || 'https://api.example.com';
  const response = http.get(`${baseUrl}/users`);
}
```

运行时可传递环境变量：

```bash
k6 run --env VUS=20 --env DURATION=60s --env BASE_URL=https://staging.example.com script.js
```

---

## 测试场景配置

### 简单场景

```javascript
export const options = {
  vus: 10,
  duration: '30s',
};
```

### 分阶段场景（Ramp-up/Ramp-down）

```javascript
export const options = {
  stages: [
    { duration: '30s', target: 20 },   // 30秒内增加到20个VU
    { duration: '1m', target: 20 },    // 保持20个VU 1分钟
    { duration: '30s', target: 50 },   // 30秒内增加到50个VU
    { duration: '1m', target: 50 },    // 保持50个VU 1分钟
    { duration: '30s', target: 0 },    // 30秒内减少到0个VU
  ],
};
```

### 多个场景

```javascript
export const options = {
  scenarios: {
    // 场景1：正常负载
    normal_load: {
      executor: 'constant-vus',
      vus: 10,
      duration: '5m',
    },
    
    // 场景2：峰值测试
    spike_test: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '10s', target: 100 },
        { duration: '1m', target: 100 },
        { duration: '10s', target: 0 },
      ],
      startTime: '2m',  // 2分钟后开始
    },
    
    // 场景3：浸泡测试
    soak_test: {
      executor: 'constant-arrival-rate',
      rate: 10,  // 每秒10个迭代
      timeUnit: '1s',
      duration: '30m',
      preAllocatedVUs: 20,
      maxVUs: 50,
    },
  },
};
```

### 场景执行器类型

1. **shared-iterations**：共享迭代次数
2. **per-vu-iterations**：每个 VU 执行固定次数迭代
3. **constant-vus**：固定数量的 VU
4. **ramping-vus**：可变数量的 VU（分阶段）
5. **constant-arrival-rate**：固定到达速率
6. **ramping-arrival-rate**：可变到达速率

---

## 指标与结果分析

### 内置指标

#### HTTP 指标

- `http_reqs`：HTTP 请求总数
- `http_req_duration`：HTTP 请求持续时间（总时间）
- `http_req_waiting`：等待服务器响应的时间（TTFB）
- `http_req_connecting`：建立连接的时间
- `http_req_sending`：发送请求的时间
- `http_req_receiving`：接收响应的时间
- `http_req_failed`：失败的请求百分比
- `http_req_blocked`：请求被阻塞的时间

#### 系统指标

- `vus`：当前活跃的虚拟用户数
- `vus_max`：最大虚拟用户数
- `iterations`：完成的迭代总数
- `iteration_duration`：迭代持续时间
- `data_received`：接收的数据量
- `data_sent`：发送的数据量

### 使用阈值

```javascript
export const options = {
  vus: 10,
  duration: '30s',
  
  thresholds: {
    // HTTP 请求失败率 < 1%
    http_req_failed: ['rate<0.01'],
    
    // 95% 的请求响应时间 < 500ms
    http_req_duration: ['p(95)<500'],
    
    // 平均响应时间 < 300ms
    http_req_duration: ['avg<300'],
    
    // 自定义指标阈值
    my_counter: ['count>100'],
    my_rate: ['rate>0.9'],
    my_trend: ['p(99)<1000'],
  },
};
```

### 输出结果到文件

```bash
# JSON 格式
k6 run --out json=results.json script.js

# CSV 格式
k6 run --out csv=results.csv script.js

# InfluxDB
k6 run --out influxdb=http://localhost:8086/k6 script.js

# CloudWatch
k6 run --out cloudwatch script.js
```

### 结果分析示例

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Trend } from 'k6/metrics';

const responseTime = new Trend('response_time');

export const options = {
  vus: 50,
  duration: '2m',
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const start = Date.now();
  const response = http.get('https://api.example.com/data');
  const duration = Date.now() - start;
  
  responseTime.add(duration);
  
  check(response, {
    '状态码是 200': (r) => r.status === 200,
  });
  
  sleep(1);
}
```

---

## 高级功能

### 1. 使用外部数据文件

```javascript
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// 加载 CSV 文件
const users = new SharedArray('users', function () {
  return papaparse.parse(open('./users.csv'), { header: true }).data;
});

export default function () {
  const user = users[__VU % users.length];
  console.log(`使用用户: ${user.email}`);
  
  const response = http.post('https://api.example.com/login', {
    email: user.email,
    password: user.password,
  });
}
```

### 2. Cookie 和会话管理

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  // 登录获取 Cookie
  const loginResponse = http.post('https://api.example.com/login', {
    username: 'testuser',
    password: 'testpass',
  });
  
  check(loginResponse, {
    '登录成功': (r) => r.status === 200,
  });
  
  // Cookie 会自动保存，后续请求会自动携带
  const profileResponse = http.get('https://api.example.com/profile');
  
  check(profileResponse, {
    '获取用户信息成功': (r) => r.status === 200,
  });
}
```

### 3. 分组和标签

```javascript
import http from 'k6/http';
import { group, check } from 'k6';

export default function () {
  group('用户认证流程', function () {
    const loginRes = http.post(
      'https://api.example.com/login',
      { username: 'user', password: 'pass' },
      { tags: { name: 'Login' } }
    );
    check(loginRes, { '登录成功': (r) => r.status === 200 });
  });
  
  group('获取用户数据', function () {
    const userRes = http.get(
      'https://api.example.com/user',
      { tags: { name: 'GetUser' } }
    );
    check(userRes, { '获取成功': (r) => r.status === 200 });
  });
}
```

### 4. WebSocket 测试

```javascript
import ws from 'k6/ws';
import { check } from 'k6';

export default function () {
  const url = 'ws://echo.websocket.org';
  const params = { tags: { name: 'WebSocket' } };
  
  const response = ws.connect(url, params, function (socket) {
    socket.on('open', function () {
      socket.send('Hello from k6!');
    });
    
    socket.on('message', function (data) {
      console.log('收到消息:', data);
      socket.close();
    });
    
    socket.on('close', function () {
      console.log('连接已关闭');
    });
  });
  
  check(response, { 'WebSocket 连接成功': (r) => r && r.status === 101 });
}
```

### 5. gRPC 测试

```javascript
import grpc from 'k6/net/grpc';
import { check, sleep } from 'k6';

const client = new grpc.Client();
client.load(['../proto'], 'hello.proto');

export default function () {
  client.connect('localhost:50051', {
    plaintext: true,
  });
  
  const data = { greeting: 'Bert' };
  const response = client.invoke('hello.HelloService/SayHello', data);
  
  check(response, {
    '状态码是 OK': (r) => r && r.status === grpc.StatusOK,
  });
  
  client.close();
  sleep(1);
}
```

### 6. 文件上传

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const fileData = open('./test-file.pdf', 'b');
  
  const response = http.post('https://api.example.com/upload', fileData, {
    headers: {
      'Content-Type': 'application/pdf',
    },
    tags: { name: 'FileUpload' },
  });
  
  check(response, {
    '上传成功': (r) => r.status === 200,
  });
}
```

### 7. 使用 JavaScript 库

k6 支持使用 npm 包（通过 jslib.k6.io）：

```javascript
// 使用 lodash
import _ from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';

export default function () {
  const array = [1, 2, 3, 4, 5];
  const shuffled = _.shuffle(array);
  console.log('打乱后的数组:', shuffled);
}
```

---

## 最佳实践

### 1. 脚本组织

```javascript
// config.js - 配置文件
export const config = {
  baseUrl: __ENV.BASE_URL || 'https://api.example.com',
  vus: parseInt(__ENV.VUS) || 10,
  duration: __ENV.DURATION || '30s',
};

// utils.js - 工具函数
export function generateRandomEmail() {
  return `user${Math.random().toString(36).substring(7)}@example.com`;
}

export function sleepRandom(min, max) {
  sleep(Math.random() * (max - min) + min);
}

// test.js - 主测试脚本
import { config } from './config.js';
import { generateRandomEmail, sleepRandom } from './utils.js';
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  vus: config.vus,
  duration: config.duration,
};

export default function () {
  const email = generateRandomEmail();
  const response = http.get(`${config.baseUrl}/users?email=${email}`);
  check(response, { '状态码是 200': (r) => r.status === 200 });
  sleepRandom(1, 3);
}
```

### 2. 错误处理

```javascript
import http from 'k6/http';
import { check } from 'k6';

export default function () {
  const response = http.get('https://api.example.com/data');
  
  // 检查响应是否成功
  if (!check(response, {
    '请求成功': (r) => r.status === 200,
  })) {
    // 记录错误但不中断测试
    console.error(`请求失败: ${response.status}`);
    return;
  }
  
  // 处理成功响应
  try {
    const data = JSON.parse(response.body);
    // 处理数据...
  } catch (e) {
    console.error('JSON 解析失败:', e);
  }
}
```

### 3. 性能优化

```javascript
// 使用批处理减少网络往返
import http from 'k6/http';

export default function () {
  const responses = http.batch([
    ['GET', 'https://api.example.com/users'],
    ['GET', 'https://api.example.com/posts'],
    ['GET', 'https://api.example.com/comments'],
  ]);
  
  // 处理所有响应
  responses.forEach((response, index) => {
    console.log(`响应 ${index}: ${response.status}`);
  });
}
```

### 4. 测试数据管理

```javascript
import { SharedArray } from 'k6/data';

// 使用 SharedArray 节省内存
const testData = new SharedArray('test_data', function () {
  return JSON.parse(open('./test-data.json'));
});

export default function () {
  // 每个 VU 使用不同的数据
  const data = testData[__VU % testData.length];
  // 使用数据进行测试...
}
```

### 5. CI/CD 集成

#### GitHub Actions 示例

```yaml
name: k6 Performance Tests

on: [push, pull_request]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Run k6 tests
        uses: grafana/k6-action@v0.2.0
        with:
          filename: tests/load-test.js
          cloud: false
          summary: true
```

#### GitLab CI 示例

```yaml
performance:
  image: grafana/k6:latest
  script:
    - k6 run --out json=results.json tests/load-test.js
  artifacts:
    reports:
      performance: results.json
```

---

## 与其他工具对比

### k6 vs JMeter

| 特性 | k6 | JMeter |
|------|----|--------|
| 脚本语言 | JavaScript | XML/GUI |
| 资源消耗 | 低 | 较高 |
| 学习曲线 | 平缓（对开发者友好） | 陡峭 |
| CI/CD 集成 | 优秀 | 一般 |
| 性能 | 高 | 中等 |
| 社区 | 活跃 | 非常活跃 |

### k6 vs Gatling

| 特性 | k6 | Gatling |
|------|----|---------|
| 脚本语言 | JavaScript | Scala/Java |
| 资源消耗 | 低 | 低 |
| 报告 | 简洁 | 详细美观 |
| 学习曲线 | 平缓 | 中等 |
| 性能 | 高 | 高 |

### k6 vs Locust

| 特性 | k6 | Locust |
|------|----|--------|
| 脚本语言 | JavaScript | Python |
| 分布式执行 | 需要 k6 Cloud | 内置支持 |
| 资源消耗 | 低 | 低 |
| Web UI | 无 | 有 |
| 性能 | 高 | 高 |

---

## 参考资料

### 官方资源

- **官方网站**：https://k6.io/
- **官方文档**：https://grafana.com/docs/k6/latest/
- **GitHub 仓库**：https://github.com/grafana/k6
- **社区论坛**：https://community.k6.io/

### 学习资源

- **k6 学习路径**：https://k6.io/docs/learning/
- **示例脚本**：https://github.com/grafana/k6-docs/tree/main/src/data/docs/examples
- **最佳实践指南**：https://k6.io/docs/test-authoring/best-practices/

### 视频教程

- k6 官方 YouTube 频道
- Grafana 官方培训课程

### 社区

- **Slack 社区**：https://k6.io/slack
- **Stack Overflow**：使用 `k6` 标签
- **Reddit**：r/k6testing

---

## 总结

k6 是一款现代化的负载测试工具，具有以下优势：

1. **开发者友好**：使用 JavaScript 编写脚本，易于学习和使用
2. **高性能**：资源占用低，可模拟大量并发用户
3. **易于集成**：完美支持 CI/CD 流程
4. **功能丰富**：支持多种协议和测试场景
5. **活跃社区**：持续更新和完善

无论是 API 测试、微服务测试还是网站性能测试，k6 都是一个优秀的选择。建议从简单的脚本开始，逐步学习高级功能，结合实际项目需求进行实践。

---

**祝您学习愉快！如有问题，欢迎查阅官方文档或社区资源。**

