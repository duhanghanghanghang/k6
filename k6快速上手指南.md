# k6 å¿«é€Ÿä¸Šæ‰‹æŒ‡å— - ä»é›¶åˆ°å®æˆ˜

## ä¸ºä»€ä¹ˆé€‰æ‹© k6ï¼Ÿ

åŸºäºå¯¹æ¯”åˆ†æï¼Œk6 çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

âœ… **ç®€æ´é«˜æ•ˆ**ï¼šJavaScript è„šæœ¬ï¼Œå‡ è¡Œä»£ç å³å¯å®Œæˆæµ‹è¯•  
âœ… **æ€§èƒ½å“è¶Š**ï¼šå•æœºå¯æ¨¡æ‹Ÿ 10,000+ å¹¶å‘ç”¨æˆ·  
âœ… **å¯åŠ¨å¿«é€Ÿ**ï¼š<1 ç§’å¯åŠ¨ï¼Œæ— éœ€ç­‰å¾…  
âœ… **èµ„æºå‹å¥½**ï¼šå†…å­˜å ç”¨ä»…ä¸º JMeter çš„ 1/3  
âœ… **CI/CD å®Œç¾**ï¼šåŸç”Ÿæ”¯æŒè‡ªåŠ¨åŒ–æµç¨‹  
âœ… **ç°ä»£å·¥å…·**ï¼šç¬¦åˆå¼€å‘è€…ä¹ æƒ¯çš„å·¥ä½œæµ  

---

## 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šå®‰è£… k6

**macOS**ï¼š
```bash
brew install k6
```

**Linux**ï¼š
```bash
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

**éªŒè¯å®‰è£…**ï¼š
```bash
k6 version
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `quick-start.js`ï¼š

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 10,           // 10 ä¸ªè™šæ‹Ÿç”¨æˆ·
  duration: '30s',   // æŒç»­ 30 ç§’
};

export default function () {
  const response = http.get('https://test-api.k6.io/public/crocodiles/');
  
  check(response, {
    'çŠ¶æ€ç æ˜¯ 200': (r) => r.status === 200,
    'å“åº”æ—¶é—´ < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);  // æ¨¡æ‹Ÿç”¨æˆ·æ€è€ƒæ—¶é—´
}
```

### æ­¥éª¤ 3ï¼šè¿è¡Œæµ‹è¯•

```bash
k6 run quick-start.js
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
âœ“ çŠ¶æ€ç æ˜¯ 200
âœ“ å“åº”æ—¶é—´ < 500ms

checks.........................: 100.00% âœ“ 300      âœ— 0
http_req_duration..............: avg=234ms min=120ms max=450ms p(95)=380ms
http_reqs......................: 100     3.33/s
iterations.....................: 100     3.33/s
```

**å®Œæˆï¼** ğŸ‰ ä½ å·²ç»æˆåŠŸè¿è¡Œäº†ç¬¬ä¸€ä¸ª k6 æµ‹è¯•ã€‚

---

## å®æˆ˜ç¤ºä¾‹é›†åˆ

### ç¤ºä¾‹ 1ï¼šAPI è´Ÿè½½æµ‹è¯•

**åœºæ™¯**ï¼šæµ‹è¯•ç”¨æˆ·ç™»å½• APIï¼Œæ¨¡æ‹Ÿ 50 ä¸ªç”¨æˆ·ï¼ŒæŒç»­ 2 åˆ†é’Ÿ

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

// è‡ªå®šä¹‰æŒ‡æ ‡ï¼šç™»å½•æˆåŠŸç‡
const loginSuccessRate = new Rate('login_success');

export const options = {
  stages: [
    { duration: '30s', target: 20 },   // 30ç§’å†…å¢åŠ åˆ°20ä¸ªç”¨æˆ·
    { duration: '1m', target: 50 },    // 1åˆ†é’Ÿå†…å¢åŠ åˆ°50ä¸ªç”¨æˆ·
    { duration: '1m', target: 50 },   // ä¿æŒ50ä¸ªç”¨æˆ·1åˆ†é’Ÿ
    { duration: '30s', target: 0 },    // 30ç§’å†…å‡å°‘åˆ°0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],  // 95%è¯·æ±‚<500msï¼Œ99%<1000ms
    http_req_failed: ['rate<0.01'],                   // å¤±è´¥ç‡<1%
    login_success: ['rate>0.95'],                     // ç™»å½•æˆåŠŸç‡>95%
  },
};

export default function () {
  // ç™»å½•è¯·æ±‚
  const loginResponse = http.post('https://api.example.com/login', 
    JSON.stringify({
      username: `user${__VU}`,  // æ¯ä¸ªVUä½¿ç”¨ä¸åŒçš„ç”¨æˆ·å
      password: 'password123',
    }),
    {
      headers: { 'Content-Type': 'application/json' },
      tags: { name: 'Login' },
    }
  );
  
  const loginSuccess = check(loginResponse, {
    'ç™»å½•çŠ¶æ€ç æ˜¯ 200': (r) => r.status === 200,
    'å“åº”åŒ…å« token': (r) => JSON.parse(r.body).token !== undefined,
  });
  
  loginSuccessRate.add(loginSuccess);
  
  if (loginSuccess) {
    const token = JSON.parse(loginResponse.body).token;
    
    // ä½¿ç”¨ token è·å–ç”¨æˆ·ä¿¡æ¯
    const userInfoResponse = http.get('https://api.example.com/user/profile', {
      headers: { 'Authorization': `Bearer ${token}` },
      tags: { name: 'GetUserProfile' },
    });
    
    check(userInfoResponse, {
      'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ': (r) => r.status === 200,
    });
  }
  
  sleep(1);
}
```

**è¿è¡Œ**ï¼š
```bash
k6 run api-load-test.js
```

### ç¤ºä¾‹ 2ï¼šRESTful API å®Œæ•´æµç¨‹æµ‹è¯•

**åœºæ™¯**ï¼šæµ‹è¯• CRUD æ“ä½œçš„å®Œæ•´æµç¨‹

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { group } from 'k6';

const BASE_URL = __ENV.BASE_URL || 'https://api.example.com';

export const options = {
  vus: 20,
  duration: '2m',
  thresholds: {
    'http_req_duration{name:Create}': ['p(95)<500'],
    'http_req_duration{name:Read}': ['p(95)<300'],
    'http_req_duration{name:Update}': ['p(95)<500'],
    'http_req_duration{name:Delete}': ['p(95)<300'],
  },
};

export default function () {
  let resourceId;
  
  group('åˆ›å»ºèµ„æº', function () {
    const payload = JSON.stringify({
      name: `Resource ${__VU}-${__ITER}`,
      description: 'Test resource',
    });
    
    const createResponse = http.post(
      `${BASE_URL}/resources`,
      payload,
      {
        headers: { 'Content-Type': 'application/json' },
        tags: { name: 'Create' },
      }
    );
    
    const createSuccess = check(createResponse, {
      'åˆ›å»ºæˆåŠŸ': (r) => r.status === 201,
      'è¿”å›èµ„æºID': (r) => {
        if (r.status === 201) {
          resourceId = JSON.parse(r.body).id;
          return resourceId !== undefined;
        }
        return false;
      },
    });
    
    if (!createSuccess) {
      return;  // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè·³è¿‡åç»­æ“ä½œ
    }
  });
  
  sleep(1);
  
  group('è¯»å–èµ„æº', function () {
    const readResponse = http.get(
      `${BASE_URL}/resources/${resourceId}`,
      { tags: { name: 'Read' } }
    );
    
    check(readResponse, {
      'è¯»å–æˆåŠŸ': (r) => r.status === 200,
      'æ•°æ®æ­£ç¡®': (r) => {
        const data = JSON.parse(r.body);
        return data.id === resourceId;
      },
    });
  });
  
  sleep(1);
  
  group('æ›´æ–°èµ„æº', function () {
    const updatePayload = JSON.stringify({
      name: `Updated Resource ${__VU}-${__ITER}`,
    });
    
    const updateResponse = http.put(
      `${BASE_URL}/resources/${resourceId}`,
      updatePayload,
      {
        headers: { 'Content-Type': 'application/json' },
        tags: { name: 'Update' },
      }
    );
    
    check(updateResponse, {
      'æ›´æ–°æˆåŠŸ': (r) => r.status === 200,
    });
  });
  
  sleep(1);
  
  group('åˆ é™¤èµ„æº', function () {
    const deleteResponse = http.del(
      `${BASE_URL}/resources/${resourceId}`,
      { tags: { name: 'Delete' } }
    );
    
    check(deleteResponse, {
      'åˆ é™¤æˆåŠŸ': (r) => r.status === 204 || r.status === 200,
    });
  });
  
  sleep(1);
}
```

### ç¤ºä¾‹ 3ï¼šå³°å€¼æµ‹è¯•ï¼ˆSpike Testï¼‰

**åœºæ™¯**ï¼šæ¨¡æ‹Ÿçªç„¶çš„æµé‡æ¿€å¢ï¼Œæµ‹è¯•ç³»ç»ŸæŠ—å‹èƒ½åŠ›

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },    // æ­£å¸¸è´Ÿè½½ï¼š10ä¸ªç”¨æˆ·
    { duration: '10s', target: 500 },  // çªç„¶æ¿€å¢åˆ°500ä¸ªç”¨æˆ·
    { duration: '30s', target: 500 }, // ä¿æŒ500ä¸ªç”¨æˆ·30ç§’
    { duration: '10s', target: 10 },  // å¿«é€Ÿå›è½åˆ°10ä¸ªç”¨æˆ·
    { duration: '1m', target: 10 },    // æ¢å¤æ­£å¸¸
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'],  // å³°å€¼æ—¶å…è®¸å“åº”æ—¶é—´ç¨é•¿
    http_req_failed: ['rate<0.05'],     // å…è®¸5%å¤±è´¥ç‡
  },
};

export default function () {
  const response = http.get('https://api.example.com/data');
  
  check(response, {
    'è¯·æ±‚æˆåŠŸ': (r) => r.status === 200,
  });
  
  sleep(Math.random() * 2 + 1);  // éšæœºç­‰å¾…1-3ç§’
}
```

### ç¤ºä¾‹ 4ï¼šä½¿ç”¨å¤–éƒ¨æ•°æ®æ–‡ä»¶

**åœºæ™¯**ï¼šä» CSV æ–‡ä»¶è¯»å–æµ‹è¯•æ•°æ®

**åˆ›å»º `users.csv`**ï¼š
```csv
email,password
user1@example.com,password123
user2@example.com,password456
user3@example.com,password789
```

**æµ‹è¯•è„šæœ¬ `data-driven-test.js`**ï¼š
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// åŠ è½½ CSV æ•°æ®ï¼ˆæ‰€æœ‰ VU å…±äº«ï¼‰
const users = new SharedArray('users', function () {
  return papaparse.parse(open('./users.csv'), { header: true }).data;
});

export const options = {
  vus: users.length,  // VU æ•°é‡ç­‰äºç”¨æˆ·æ•°é‡
  duration: '1m',
};

export default function () {
  // æ¯ä¸ª VU ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·æ•°æ®
  const user = users[__VU % users.length];
  
  const loginResponse = http.post(
    'https://api.example.com/login',
    JSON.stringify({
      email: user.email,
      password: user.password,
    }),
    {
      headers: { 'Content-Type': 'application/json' },
      tags: { name: 'Login', user: user.email },
    }
  );
  
  check(loginResponse, {
    'ç™»å½•æˆåŠŸ': (r) => r.status === 200,
  });
  
  sleep(1);
}
```

### ç¤ºä¾‹ 5ï¼šWebSocket æµ‹è¯•

**åœºæ™¯**ï¼šæµ‹è¯• WebSocket è¿æ¥çš„å®æ—¶é€šä¿¡

```javascript
import ws from 'k6/ws';
import { check } from 'k6';

export const options = {
  vus: 10,
  duration: '30s',
};

export default function () {
  const url = 'wss://echo.websocket.org';
  const params = { tags: { name: 'WebSocket' } };
  
  const response = ws.connect(url, params, function (socket) {
    socket.on('open', function () {
      console.log('WebSocket è¿æ¥å·²å»ºç«‹');
      socket.send(JSON.stringify({ message: 'Hello from k6' }));
    });
    
    socket.on('message', function (data) {
      const message = JSON.parse(data);
      console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
      
      check(message, {
        'æ¶ˆæ¯å†…å®¹æ­£ç¡®': (m) => m.message === 'Hello from k6',
      });
      
      socket.close();
    });
    
    socket.on('close', function () {
      console.log('WebSocket è¿æ¥å·²å…³é—­');
    });
    
    socket.on('error', function (e) {
      console.error('WebSocket é”™è¯¯:', e);
    });
    
    socket.setTimeout(function () {
      console.log('è¿æ¥è¶…æ—¶ï¼Œå…³é—­è¿æ¥');
      socket.close();
    }, 5000);
  });
  
  check(response, {
    'WebSocket è¿æ¥æˆåŠŸ': (r) => r && r.status === 101,
  });
}
```

---

## å¸¸ç”¨é…ç½®æ¨¡æ¿

### æ¨¡æ¿ 1ï¼šæ¸è¿›å¼è´Ÿè½½æµ‹è¯•

```javascript
export const options = {
  stages: [
    { duration: '2m', target: 100 },   // 2åˆ†é’Ÿå¢åŠ åˆ°100ä¸ªç”¨æˆ·
    { duration: '5m', target: 100 },  // ä¿æŒ100ä¸ªç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 200 },  // 2åˆ†é’Ÿå¢åŠ åˆ°200ä¸ªç”¨æˆ·
    { duration: '5m', target: 200 },  // ä¿æŒ200ä¸ªç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 0 },     // 2åˆ†é’Ÿå‡å°‘åˆ°0
  ],
};
```

### æ¨¡æ¿ 2ï¼šå›ºå®šè´Ÿè½½æµ‹è¯•

```javascript
export const options = {
  vus: 50,
  duration: '10m',
};
```

### æ¨¡æ¿ 3ï¼šå›ºå®šåˆ°è¾¾é€Ÿç‡

```javascript
export const options = {
  scenarios: {
    constant_arrival_rate: {
      executor: 'constant-arrival-rate',
      rate: 10,        // æ¯ç§’10ä¸ªè¯·æ±‚
      timeUnit: '1s',
      duration: '5m',
      preAllocatedVUs: 20,
      maxVUs: 50,
    },
  },
};
```

### æ¨¡æ¿ 4ï¼šæ¯ä¸ª VU å›ºå®šè¿­ä»£æ¬¡æ•°

```javascript
export const options = {
  scenarios: {
    per_vu_iterations: {
      executor: 'per-vu-iterations',
      vus: 10,
      iterations: 20,  // æ¯ä¸ª VU æ‰§è¡Œ 20 æ¬¡è¿­ä»£
    },
  },
};
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®

```javascript
export const options = {
  vus: parseInt(__ENV.VUS) || 10,
  duration: __ENV.DURATION || '30s',
};

const BASE_URL = __ENV.BASE_URL || 'https://api.example.com';
```

**è¿è¡Œ**ï¼š
```bash
k6 run --env VUS=50 --env DURATION=5m --env BASE_URL=https://staging.example.com script.js
```

### 2. ä½¿ç”¨é˜ˆå€¼ç¡®ä¿è´¨é‡

```javascript
export const options = {
  thresholds: {
    // å“åº”æ—¶é—´é˜ˆå€¼
    http_req_duration: [
      'avg<300',      // å¹³å‡å“åº”æ—¶é—´ < 300ms
      'p(90)<500',    // 90% è¯·æ±‚ < 500ms
      'p(95)<800',    // 95% è¯·æ±‚ < 800ms
      'p(99)<1500',   // 99% è¯·æ±‚ < 1500ms
    ],
    
    // é”™è¯¯ç‡é˜ˆå€¼
    http_req_failed: ['rate<0.01'],  // å¤±è´¥ç‡ < 1%
    
    // è‡ªå®šä¹‰æŒ‡æ ‡é˜ˆå€¼
    login_success: ['rate>0.95'],    // ç™»å½•æˆåŠŸç‡ > 95%
  },
};
```

### 3. ä½¿ç”¨æ ‡ç­¾åˆ†ç»„ç»Ÿè®¡

```javascript
// ä¸ºä¸åŒç±»å‹çš„è¯·æ±‚æ·»åŠ æ ‡ç­¾
http.get('https://api.example.com/users', { tags: { name: 'GetUsers', type: 'read' } });
http.post('https://api.example.com/users', payload, { tags: { name: 'CreateUser', type: 'write' } });

// åœ¨é˜ˆå€¼ä¸­åˆ†åˆ«ç»Ÿè®¡
thresholds: {
  'http_req_duration{type:read}': ['p(95)<300'],
  'http_req_duration{type:write}': ['p(95)<500'],
}
```

### 4. åˆç†ä½¿ç”¨ sleep æ¨¡æ‹ŸçœŸå®ç”¨æˆ·

```javascript
// ä¸å¥½çš„åšæ³•ï¼šå›ºå®š sleep
sleep(1);

// å¥½çš„åšæ³•ï¼šéšæœº sleepï¼Œæ›´æ¥è¿‘çœŸå®ç”¨æˆ·è¡Œä¸º
sleep(Math.random() * 2 + 1);  // 1-3ç§’éšæœºç­‰å¾…

// æˆ–è€…ä½¿ç”¨æ­£æ€åˆ†å¸ƒ
function normalSleep(mean, stdDev) {
  // Box-Muller å˜æ¢ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°
  const u1 = Math.random();
  const u2 = Math.random();
  const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
  return Math.max(0, mean + z * stdDev);
}

sleep(normalSleep(2, 0.5));  // å¹³å‡2ç§’ï¼Œæ ‡å‡†å·®0.5ç§’
```

### 5. é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

```javascript
import http from 'k6/http';
import { sleep } from 'k6';

function httpGetWithRetry(url, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    const response = http.get(url);
    
    if (response.status === 200) {
      return response;
    }
    
    if (i < maxRetries - 1) {
      sleep(Math.pow(2, i));  // æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s
    }
  }
  
  return null;  // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
}

export default function () {
  const response = httpGetWithRetry('https://api.example.com/data');
  
  if (!response) {
    console.error('è¯·æ±‚å¤±è´¥ï¼Œå·²é‡è¯•å¤šæ¬¡');
  }
}
```

### 6. è¾“å‡ºç»“æœåˆ°æ–‡ä»¶

```bash
# JSON æ ¼å¼
k6 run --out json=results.json script.js

# CSV æ ¼å¼
k6 run --out csv=results.csv script.js

# InfluxDBï¼ˆç”¨äº Grafana å¯è§†åŒ–ï¼‰
k6 run --out influxdb=http://localhost:8086/k6 script.js

# å¤šä¸ªè¾“å‡º
k6 run --out json=results.json --out csv=results.csv script.js
```

---

## CI/CD é›†æˆç¤ºä¾‹

### GitHub Actions

åˆ›å»º `.github/workflows/performance.yml`ï¼š

```yaml
name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run k6 tests
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/load-test.js
          cloud: false
          summary: true
          quiet: false
          
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: k6-results
          path: results.json
```

### GitLab CI

åˆ›å»º `.gitlab-ci.yml`ï¼š

```yaml
stages:
  - test

performance:
  stage: test
  image: grafana/k6:latest
  script:
    - k6 run --out json=results.json tests/load-test.js
  artifacts:
    when: always
    reports:
      performance: results.json
  only:
    - main
    - develop
```

### Jenkins Pipeline

åˆ›å»º `Jenkinsfile`ï¼š

```groovy
pipeline {
    agent any
    
    stages {
        stage('Performance Test') {
            steps {
                sh '''
                    docker run --rm -i \
                    -v ${WORKSPACE}:/scripts \
                    grafana/k6:latest \
                    run /scripts/tests/load-test.js \
                    --out json=/scripts/results.json
                '''
            }
        }
        
        stage('Publish Results') {
            steps {
                publishHTML([
                    reportName: 'k6 Performance Report',
                    reportDir: '.',
                    reportFiles: 'results.html',
                    keepAll: true
                ])
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'results.json', fingerprint: true
        }
    }
}
```

---

## å¸¸è§é—®é¢˜è§£å†³

### Q1: å¦‚ä½•æµ‹è¯•éœ€è¦è®¤è¯çš„ APIï¼Ÿ

```javascript
// æ–¹æ³•1ï¼šä½¿ç”¨ Cookieï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
const loginResponse = http.post('https://api.example.com/login', {
  username: 'user',
  password: 'pass',
});
// åç»­è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ Cookie

// æ–¹æ³•2ï¼šä½¿ç”¨ Token
const loginResponse = http.post('https://api.example.com/login', {
  username: 'user',
  password: 'pass',
});
const token = JSON.parse(loginResponse.body).token;

http.get('https://api.example.com/protected', {
  headers: { 'Authorization': `Bearer ${token}` },
});
```

### Q2: å¦‚ä½•æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ï¼Ÿ

```javascript
import http from 'k6/http';

export default function () {
  const fileData = open('./test-file.pdf', 'b');  // 'b' è¡¨ç¤ºäºŒè¿›åˆ¶æ¨¡å¼
  
  const response = http.post(
    'https://api.example.com/upload',
    fileData,
    {
      headers: {
        'Content-Type': 'application/pdf',
      },
    }
  );
}
```

### Q3: å¦‚ä½•æ¨¡æ‹Ÿä¸åŒçš„ç”¨æˆ·è¡Œä¸ºï¼Ÿ

```javascript
export default function () {
  const userType = __VU % 3;  // å°†ç”¨æˆ·åˆ†ä¸º3ç§ç±»å‹
  
  if (userType === 0) {
    // ç±»å‹1ï¼šåªæµè§ˆ
    http.get('https://api.example.com/products');
  } else if (userType === 1) {
    // ç±»å‹2ï¼šæµè§ˆå¹¶è´­ä¹°
    http.get('https://api.example.com/products');
    http.post('https://api.example.com/orders', { productId: 123 });
  } else {
    // ç±»å‹3ï¼šæœç´¢å’Œè¯„è®º
    http.get('https://api.example.com/search?q=test');
    http.post('https://api.example.com/comments', { text: 'Great!' });
  }
}
```

### Q4: å¦‚ä½•å¤„ç† JSON å“åº”ï¼Ÿ

```javascript
export default function () {
  const response = http.get('https://api.example.com/users');
  
  // æ–¹æ³•1ï¼šä½¿ç”¨ try-catch
  try {
    const users = JSON.parse(response.body);
    console.log(`è·å–åˆ° ${users.length} ä¸ªç”¨æˆ·`);
  } catch (e) {
    console.error('JSON è§£æå¤±è´¥:', e);
  }
  
  // æ–¹æ³•2ï¼šä½¿ç”¨ check éªŒè¯
  check(response, {
    'JSON æ ¼å¼æœ‰æ•ˆ': (r) => {
      try {
        JSON.parse(r.body);
        return true;
      } catch {
        return false;
      }
    },
  });
}
```

---

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. ä½¿ç”¨æ‰¹å¤„ç†å‡å°‘ç½‘ç»œå¾€è¿”

```javascript
// ä¸å¥½çš„åšæ³•ï¼šé€ä¸ªè¯·æ±‚
http.get('https://api.example.com/users/1');
http.get('https://api.example.com/users/2');
http.get('https://api.example.com/users/3');

// å¥½çš„åšæ³•ï¼šæ‰¹å¤„ç†
const responses = http.batch([
  ['GET', 'https://api.example.com/users/1'],
  ['GET', 'https://api.example.com/users/2'],
  ['GET', 'https://api.example.com/users/3'],
]);
```

### 2. ä½¿ç”¨ SharedArray èŠ‚çœå†…å­˜

```javascript
import { SharedArray } from 'k6/data';

// SharedArray åœ¨æ‰€æœ‰ VU ä¹‹é—´å…±äº«ï¼ŒèŠ‚çœå†…å­˜
const testData = new SharedArray('data', function () {
  return JSON.parse(open('./large-data.json'));
});

export default function () {
  const item = testData[__VU % testData.length];
  // ä½¿ç”¨æ•°æ®...
}
```

### 3. åˆç†è®¾ç½® VU æ•°é‡

```javascript
// æ ¹æ®ç³»ç»Ÿèµ„æºè®¾ç½®
// CPU æ ¸å¿ƒæ•° * 2-4 æ˜¯ä¸€ä¸ªå¥½çš„èµ·ç‚¹
export const options = {
  vus: 10,  // ä»å°‘é‡å¼€å§‹ï¼Œé€æ­¥å¢åŠ 
  duration: '30s',
};
```

---

## ä¸‹ä¸€æ­¥å­¦ä¹ 

1. **æ·±å…¥å­¦ä¹ **ï¼šé˜…è¯» `k6å­¦ä¹ æŒ‡å—.md` äº†è§£è¯¦ç»†åŠŸèƒ½
2. **å¯¹æ¯”åˆ†æ**ï¼šæŸ¥çœ‹ `k6-vs-JMeterå¯¹æ¯”.md` äº†è§£å·¥å…·å·®å¼‚
3. **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://grafana.com/docs/k6/latest/
4. **ç¤ºä¾‹è„šæœ¬**ï¼šhttps://github.com/grafana/k6-docs/tree/main/src/data/docs/examples
5. **ç¤¾åŒºæ”¯æŒ**ï¼šhttps://k6.io/slack

---

## æ€»ç»“

k6 çš„ä¼˜åŠ¿åœ¨äºï¼š

âœ… **ç®€æ´**ï¼šJavaScript è„šæœ¬ï¼Œæ˜“äºç¼–å†™å’Œç»´æŠ¤  
âœ… **å¿«é€Ÿ**ï¼šå¯åŠ¨å¿«ï¼Œæ‰§è¡Œæ•ˆç‡é«˜  
âœ… **é«˜æ•ˆ**ï¼šèµ„æºå ç”¨ä½ï¼Œæ€§èƒ½ä¼˜å¼‚  
âœ… **ç°ä»£**ï¼šå®Œç¾æ”¯æŒ CI/CD å’Œäº‘åŸç”Ÿ  

**ç«‹å³å¼€å§‹ä½¿ç”¨ k6ï¼Œä½“éªŒç°ä»£åŒ–çš„æ€§èƒ½æµ‹è¯•ï¼** ğŸš€

