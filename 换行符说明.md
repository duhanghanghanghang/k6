# 换行符详解：\r\n 和 \n

## 什么是换行符？

换行符是文本文件中用来表示"换行"的特殊字符。不同操作系统使用不同的换行符标准。

## 三种换行符类型

### 1. `\n` - LF (Line Feed)

- **全称**：Line Feed（换行）
- **ASCII 码**：10 (0x0A)
- **使用系统**：
  - Unix
  - Linux
  - macOS (10.0+)
- **示例**：
  ```javascript
  const text = "第一行\n第二行\n第三行";
  ```

### 2. `\r\n` - CRLF (Carriage Return + Line Feed)

- **全称**：Carriage Return + Line Feed（回车+换行）
- **ASCII 码**：13 + 10 (0x0D 0x0A)
- **使用系统**：
  - Windows
  - DOS
- **示例**：
  ```javascript
  const text = "第一行\r\n第二行\r\n第三行";
  ```

### 3. `\r` - CR (Carriage Return)

- **全称**：Carriage Return（回车）
- **ASCII 码**：13 (0x0D)
- **使用系统**：
  - 老式 Mac (Mac OS 9 及更早版本)
- **示例**：
  ```javascript
  const text = "第一行\r第二行\r第三行";
  ```

## 为什么会有不同的换行符？

### 历史原因

1. **打字机时代**：
   - `\r` (Carriage Return)：打字机的"回车"，将打字头移回行首
   - `\n` (Line Feed)：打字机的"换行"，将纸张向上移动一行

2. **计算机时代**：
   - Unix/Linux：简化设计，只用 `\n`
   - Windows：保持兼容性，使用 `\r\n`
   - 老式 Mac：只用 `\r`

## 实际影响

### 问题场景

**场景 1：跨平台文件传输**
```bash
# Windows 创建的文件
echo "Hello" > file.txt  # 使用 \r\n

# Linux 读取
cat file.txt  # 可能显示异常
```

**场景 2：Git 版本控制**
```bash
# Git 会自动转换换行符
git config core.autocrlf true   # Windows: 提交时转换为 LF，检出时转换为 CRLF
git config core.autocrlf false  # 不转换
```

**场景 3：文本处理**
```javascript
// 如果文件混合了不同的换行符
const content = "第一行\r\n第二行\n第三行\r第四行";

// 分割时可能出问题
const lines = content.split('\n');  // 只按 \n 分割，\r\n 会保留 \r
```

## 如何处理换行符兼容性

### 方法 1：统一转换为 `\n`

```javascript
// JavaScript/k6 中处理
function normalizeLineEndings(text) {
  // 将 \r\n 和 \r 都转换为 \n
  return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
}

const content = open('./file.txt');
const normalized = normalizeLineEndings(content);
const lines = normalized.split('\n');
```

### 方法 2：使用正则表达式匹配所有换行符

```javascript
// 匹配所有类型的换行符
const lines = content.split(/\r\n|\r|\n/);

// 或者
const lines = content.split(/\r?\n|\r/);
```

### 方法 3：在 k6 中处理 CSV 文件

```javascript
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// papaparse 会自动处理不同的换行符
const csvContent = open('./data.csv');
const data = papaparse.parse(csvContent, { header: true }).data;
```

### 方法 4：读取文件时处理

```javascript
export default function () {
  // k6 的 open() 函数会自动处理换行符
  const content = open('./file.txt');
  
  // 如果需要手动处理
  const normalized = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const lines = normalized.split('\n');
}
```

## 在 k6 中的最佳实践

### 1. CSV 文件处理

```javascript
import { SharedArray } from 'k6/data';
import papaparse from 'https://jslib.k6.io/papaparse/5.1.1/index.js';

// papaparse 会自动处理换行符
const users = new SharedArray('users', function () {
  const csvContent = open('./users.csv');
  return papaparse.parse(csvContent, { header: true }).data;
});
```

### 2. 文本文件处理

```javascript
function readLines(filePath) {
  const content = open(filePath);
  // 统一转换为 \n
  const normalized = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  return normalized.split('\n').filter(line => line.length > 0);
}

const lines = readLines('./data.txt');
```

### 3. JSON 文件处理

```javascript
// JSON 文件通常不会有换行符问题，因为 JSON 解析器会自动处理
const jsonContent = open('./data.json');
const data = JSON.parse(jsonContent);
```

## 常见问题解决

### Q1: 为什么我的 CSV 文件读取后第一行有 `\r`？

**原因**：文件使用 `\r\n` 换行，但只按 `\n` 分割了。

**解决**：
```javascript
const content = open('./file.csv');
const normalized = content.replace(/\r\n/g, '\n');
const lines = normalized.split('\n');
```

### Q2: Git 提交时出现换行符警告？

**解决**：
```bash
# 设置 Git 自动转换
git config core.autocrlf true  # Windows
git config core.autocrlf input # Linux/Mac

# 或者统一使用 LF
git config core.autocrlf false
```

### Q3: 在不同系统间共享文件？

**最佳实践**：
- 统一使用 `\n` (LF)
- 在 `.gitattributes` 中设置：
  ```
  * text=auto eol=lf
  ```

## 工具和命令

### 查看文件的换行符类型

**Linux/Mac**：
```bash
file file.txt
# 或者
od -c file.txt | head
```

**Windows (PowerShell)**：
```powershell
Get-Content file.txt -Raw | ForEach-Object { $_.Replace("`r`n", "[CRLF]").Replace("`n", "[LF]").Replace("`r", "[CR]") }
```

### 转换换行符

**Linux/Mac**：
```bash
# 转换为 LF
dos2unix file.txt

# 转换为 CRLF
unix2dos file.txt
```

**Windows (PowerShell)**：
```powershell
# 转换为 LF
(Get-Content file.txt -Raw) -replace "`r`n", "`n" | Set-Content file.txt

# 转换为 CRLF
(Get-Content file.txt -Raw) -replace "`n", "`r`n" | Set-Content file.txt
```

## 总结

| 换行符 | 系统 | ASCII | 说明 |
|--------|------|-------|------|
| `\n` | Unix/Linux/macOS | 10 | 最常用 |
| `\r\n` | Windows | 13+10 | Windows 标准 |
| `\r` | 老式 Mac | 13 | 已淘汰 |

**最佳实践**：
- ✅ 统一使用 `\n` (LF)
- ✅ 使用工具库自动处理（如 papaparse）
- ✅ 在 Git 中配置 `core.autocrlf`
- ✅ 使用正则表达式匹配所有类型：`/\r\n|\r|\n/`

---

**记住**：现代开发中，大多数工具和库都会自动处理换行符兼容性，但了解这些概念有助于解决跨平台问题！

